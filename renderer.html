<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager - Phase 4</title>
    <style>
        @font-face {
            font-family: 'Abril Fatface';
            src: url('assets/fonts/AbrilFatface-Regular 2.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Archivo';
            src: url('assets/fonts/archivo/Archivo-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Archivo';
            src: url('assets/fonts/archivo/Archivo-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'Archivo';
            src: url('assets/fonts/archivo/Archivo-SemiBold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
        }
        @font-face {
            font-family: 'Archivo';
            src: url('assets/fonts/archivo/Archivo-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Archivo', Arial, sans-serif;
            background: #fff;
            color: #111;
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        /* NAVIGATION BREADCRUMBS */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: #666;
            background: #f7f7f7;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid #eee;
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .breadcrumb-link {
            color: #0700ff;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .breadcrumb-link:hover {
            color: #f50a68;
        }
        
        .breadcrumb-separator {
            color: #999;
            font-size: 12px;
        }
        
        .breadcrumb-current {
            color: #111;
            font-weight: 500;
        }
        
        /* DASHBOARD METRICS */
        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .metric-card {
            background: #fff;
            border-radius: 12px;
            padding: 10px 8px;
            border: 2px solid #0700ff;
            color: #0700ff;
            box-shadow: 0 1px 4px rgba(7,0,255,0.04);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            box-shadow: 0 6px 20px rgba(7,0,255,0.1);
            transform: translateY(-2px);
        }
        
        .metric-card.primary {
            background: linear-gradient(135deg, #0700ff 0%, #4338ca 100%);
            color: #fff;
            border: none;
        }
        
        .metric-card.success {
            background: linear-gradient(135deg, #e2fc0b 0%, #bef264 100%);
            color: #0700ff;
            border: none;
        }
        
        .metric-card.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: #fff;
            border: none;
        }
        
        .metric-card.danger {
            background: linear-gradient(135deg, #f50a68 0%, #ef4444 100%);
            color: #fff;
            border: none;
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .metric-card:not(.primary):not(.success):not(.warning):not(.danger) .metric-icon {
            background: #f3f4f6;
            color: #0700ff;
        }
        
        .metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Abril Fatface', serif;
            margin-bottom: 8px;
        }
        
        .metric-label {
            font-size: 14px;
            opacity: 0.8;
            font-weight: 500;
        }
        
        .metric-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            margin-top: 8px;
            opacity: 0.9;
        }
        
        .metric-change.positive {
            color: #22c55e;
        }
        
        .metric-change.negative {
            color: #ef4444;
        }
        
        /* PROJECT DETAIL VIEW */
        .project-detail {
            background: #fff;
            border-radius: 20px;
            padding: 32px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 16px rgba(7,0,255,0.06);
            margin-bottom: 24px;
            animation: fadeIn 0.4s ease-out;
        }
        
        .project-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .project-detail-title-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .project-detail-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, #e2fc0b 0%, #bef264 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0700ff;
            font-size: 2.5rem;
            box-shadow: 0 4px 12px rgba(226,252,11,0.3);
        }
        
        .project-detail-icon.overdue {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(239,68,68,0.3);
        }
        
        .project-detail-icon.due-soon {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(245,158,11,0.3);
        }
        
        .project-detail-title {
            font-size: 2.5rem;
            font-family: 'Abril Fatface', serif;
            font-weight: 400;
            color: #0700ff;
            margin-bottom: 8px;
            line-height: 1.2;
        }
        
        .project-detail-client {
            font-size: 1.2rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .project-detail-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .project-detail-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .project-stat {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .project-stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Abril Fatface', serif;
            color: #0700ff;
            margin-bottom: 8px;
        }
        
        .project-stat-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }
        
        .project-progress-large {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }
        
        .progress-header-large {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .progress-title-large {
            font-size: 1.2rem;
            font-weight: 600;
            color: #0f172a;
        }
        
        .progress-percentage-large {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0700ff;
            font-family: 'Abril Fatface', serif;
        }
        
        .progress-bar-large {
            width: 100%;
            height: 16px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .progress-fill-large {
            height: 100%;
            background: linear-gradient(90deg, #0700ff 0%, #4338ca 100%);
            border-radius: 8px;
            transition: width 0.8s ease;
            position: relative;
        }
        
        .progress-fill-large::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #64748b;
        }
        
        /* RECENT ACTIVITY FEED */
        .activity-feed {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(7,0,255,0.04);
            margin-bottom: 24px;
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .activity-title {
            font-size: 1.3rem;
            font-family: 'Abril Fatface', serif;
            font-weight: 400;
            color: #0700ff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .activity-icon.completed {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .activity-icon.created {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .activity-icon.overdue {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-description {
            color: #374151;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .activity-project {
            font-size: 12px;
            color: #6b7280;
        }
        
        .activity-time {
            font-size: 12px;
            color: #9ca3af;
            white-space: nowrap;
        }
        
        /* QUICK ACTIONS PANEL */
        .quick-actions {
            background: linear-gradient(135deg, #0700ff 0%, #4338ca 100%);
            border-radius: 16px;
            padding: 24px;
            color: #fff;
            margin-bottom: 24px;
        }
        
        .quick-actions-title {
            font-size: 1.3rem;
            font-family: 'Abril Fatface', serif;
            font-weight: 400;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .quick-action-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Archivo', Arial, sans-serif;
            font-size: 14px;
            font-weight: 500;
        }
        
        .quick-action-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .quick-action-icon {
            font-size: 20px;
        }
        
        /* PROJECT SWITCHER */
        .project-switcher {
            position: relative;
            display: inline-block;
        }
        
        .project-switcher-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .project-switcher-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .project-switcher-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 250px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 4px;
        }
        
        .project-switcher-dropdown.hidden {
            display: none;
        }
        
        .project-switcher-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f1f5f9;
            color: #374151;
        }
        
        .project-switcher-item:last-child {
            border-bottom: none;
        }
        
        .project-switcher-item:hover {
            background: #f8fafc;
        }
        
        .project-switcher-item.active {
            background: #e2fc0b;
            color: #0700ff;
            font-weight: 600;
        }
        
        .project-switcher-project {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .project-switcher-client {
            font-size: 12px;
            color: #6b7280;
        }
        
        /* DETAILED TASK MANAGEMENT */
        .detailed-tasks {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(7,0,255,0.04);
        }
        
        .detailed-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .detailed-tasks-title {
            font-size: 1.5rem;
            font-family: 'Abril Fatface', serif;
            font-weight: 400;
            color: #0700ff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .task-filters {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .task-filter-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .task-filter-btn:hover {
            background: #f3f4f6;
        }
        
        .task-filter-btn.active {
            background: #0700ff;
            color: #fff;
            border-color: #0700ff;
        }

        .task-search {
            margin-left: auto;
        }

        .task-search-input {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 14px;
            font-family: 'Archivo', Arial, sans-serif;
        }

        .task-search-input:focus {
            outline: none;
            border-color: #0700ff;
            box-shadow: 0 0 0 2px #e2fc0b44;
        }
        
        .detailed-task-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .detailed-task-item:hover {
            border-color: #0700ff;
            box-shadow: 0 4px 12px rgba(7,0,255,0.1);
        }
        
        .detailed-task-item.completed {
            background: #f0fdf4;
            border-color: #22c55e;
        }
        
        .detailed-task-item.priority {
            background: #fef2f2;
            border-color: #f50a68;
        }
        
        .detailed-task-item.overdue {
            background: #fef2f2;
            border-color: #ef4444;
        }
        
        .detailed-task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .detailed-task-content {
            flex: 1;
            margin-right: 16px;
        }
        
        .detailed-task-text {
            font-size: 16px;
            font-weight: 500;
            color: #0f172a;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .detailed-task-text.completed {
            text-decoration: line-through;
            color: #6b7280;
        }
        
        .detailed-task-meta {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .detailed-task-deadline {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .detailed-task-deadline.overdue {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .detailed-task-deadline.due-today {
            background: #fef3c7;
            color: #d97706;
        }
        
        .detailed-task-deadline.due-soon {
            background: #fef3c7;
            color: #f59e0b;
        }
        
        .detailed-task-deadline.due-later {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .detailed-task-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* VIEW MODES */
        .view-toggle {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        
        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #64748b;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .view-toggle-btn.active {
            background: #0700ff;
            color: #fff;
        }
        
        .view-toggle-btn:hover:not(.active) {
            background: #e2e8f0;
        }
        
        /* EXISTING STYLES FROM PHASE 3 */
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .title {
            font-family: 'Abril Fatface', serif;
            font-size: 2.5rem;
            font-weight: 400;
            color: #0700ff;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .date {
            color: #222;
            font-size: 1.1rem;
            font-family: 'Archivo', Arial, sans-serif;
        }
        
        .control-panel {
            background: #fff;
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(7,0,255,0.04);
            border: 1px solid #eee;
            margin-bottom: 24px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .focus-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .icon {
            width: 24px;
            height: 24px;
            padding: 8px;
            background: #e2fc0b;
            border-radius: 50%;
            color: #0700ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .select {
            border: 1px solid #0700ff;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 15px;
            min-width: 200px;
            background: #fff;
            color: #111;
            font-family: 'Archivo', Arial, sans-serif;
            transition: border 0.2s;
        }
        
        .select:focus {
            outline: none;
            border-color: #f50a68;
            box-shadow: 0 0 0 2px #e2fc0b44;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 9px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            text-decoration: none;
            font-family: 'Archivo', Arial, sans-serif;
        }
        
        .btn-primary {
            background: #0700ff;
            color: #fff;
        }
        .btn-primary:hover {
            background: #1111ff;
        }
        
        .btn-success {
            background: #e2fc0b;
            color: #0700ff;
        }
        .btn-success:hover {
            background: #f7ff6b;
        }
        
        .btn-secondary {
            background: #f50a68;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #c0084e;
        }
        
        .btn-outline {
            background: transparent;
            color: #0700ff;
            border: 1px solid #0700ff;
        }
        .btn-outline:hover {
            background: #0700ff;
            color: #fff;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: #fff;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-danger {
            background: #ef4444;
            color: #fff;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-note {
            background: #fbbf24;
            color: #92400e;
        }
        .btn-note:hover {
            background: #f59e0b;
            color: #fff;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid #eee;
            font-size: 14px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox {
            width: 16px;
            height: 16px;
            accent-color: #0700ff;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #888;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #0700ff;
            border-radius: 50%;
        }
        
        .focus-banner {
            margin-top: 16px;
            padding: 16px;
            background: #e2fc0b;
            border: 1px solid #0700ff;
            border-radius: 14px;
            animation: fadeIn 0.3s ease-out;
        }
        .focus-banner h3 {
            color: #0700ff;
            font-family: 'Abril Fatface', serif;
            font-weight: 400;
            margin-bottom: 4px;
        }
        .focus-banner p {
            color: #111;
            font-size: 15px;
        }
        
        .projects-grid {
            display: grid;
            gap: 24px;
        }
        
        .project-card {
            background: #fff;
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(7,0,255,0.04);
            border: 1.5px solid #eee;
            transition: box-shadow 0.3s, border 0.3s, transform 0.3s;
            cursor: pointer;
        }
        .project-card:hover {
            box-shadow: 0 6px 24px rgba(7,0,255,0.08);
            border: 1.5px solid #0700ff;
            transform: translateY(-4px);
        }
        .project-card.focused {
            border-color: #0700ff;
            box-shadow: 0 0 0 3px #e2fc0b55;
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .project-title-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .project-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: #e2fc0b;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0700ff;
            font-size: 1.7rem;
        }
        .project-icon.focused {
            background: #0700ff;
            color: #fff;
        }
        .project-title {
            font-size: 1.25rem;
            font-family: 'Abril Fatface', serif;
            font-weight: 400;
            color: #0700ff;
            margin-bottom: 4px;
        }
        .project-client {
            color: #111;
            font-size: 14px;
            font-family: 'Archivo', Arial, sans-serif;
        }
        .focus-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #0700ff;
            color: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        .progress-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .progress-text {
            font-size: 14px;
            color: #0700ff;
            font-weight: 500;
        }
        .progress-bar {
            width: 80px;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #0700ff;
            transition: width 0.5s ease;
        }
        .progress-fill.focused {
            background: #f50a68;
        }
        .progress-percentage {
            font-size: 14px;
            font-weight: 600;
            color: #0700ff;
        }
        
        .project-context {
            padding: 16px;
            background: #f7f7f7;
            border-left: 4px solid #e2fc0b;
            border-radius: 10px;
            margin-bottom: 16px;
        }
        .project-context.focused {
            background: #e2fc0b22;
            border-left-color: #0700ff;
        }
        .context-text {
            color: #111;
        }
        .context-label {
            font-weight: 600;
            color: #0700ff;
        }
        
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #0700ff;
            color: #fff;
            padding: 16px;
            border-radius: 10px;
            max-width: 300px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(7,0,255,0.10);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .hidden {
            display: none;
        }
        
        /* NOTES SIDEBAR - Restored from Phase 3 */
        .notes-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: #fff;
            border-left: 1px solid #e5e7eb;
            box-shadow: -4px 0 12px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: right 0.3s ease-out;
            overflow-y: auto;
        }
        
        .notes-sidebar.open {
            right: 0;
        }
        
        .notes-header {
            background: #0700ff;
            color: #fff;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1001;
        }
        
        .notes-title {
            font-family: 'Abril Fatface', serif;
            font-weight: 400;
            font-size: 1.3rem;
        }
        
        .notes-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .notes-close:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .notes-content {
            padding: 20px;
        }
        
        .add-note-section {
            background: #f7f7f7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 2px dashed #0700ff;
        }
        
        .quick-note-input {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            font-family: 'Archivo', Arial, sans-serif;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
        }
        
        .quick-note-input:focus {
            outline: none;
            border-color: #0700ff;
            box-shadow: 0 0 0 2px #e2fc0b44;
        }
        
        .note-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .color-picker {
            display: flex;
            gap: 4px;
        }
        
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border-color: #0700ff;
            transform: scale(1.2);
        }
        
        .color-yellow { background: #fde047; }
        .color-blue { background: #60a5fa; }
        .color-pink { background: #f472b6; }
        .color-green { background: #4ade80; }
        .color-orange { background: #fb923c; }
        .color-purple { background: #a78bfa; }
        
        .priority-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            background: #fff;
        }
        
        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .note-item {
            border-radius: 12px;
            padding: 16px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid;
        }
        
        .note-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        .note-item.yellow {
            background: #fefce8;
            border-left-color: #eab308;
        }
        
        .note-item.blue {
            background: #eff6ff;
            border-left-color: #3b82f6;
        }
        
        .note-item.pink {
            background: #fdf2f8;
            border-left-color: #ec4899;
        }
        
        .note-item.green {
            background: #f0fdf4;
            border-left-color: #22c55e;
        }
        
        .note-item.orange {
            background: #fff7ed;
            border-left-color: #f97316;
        }
        
        .note-item.purple {
            background: #f5f3ff;
            border-left-color: #8b5cf6;
        }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .note-priority {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .note-priority.low {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        .note-priority.medium {
            background: #fbbf24;
            color: #92400e;
        }
        
        .note-priority.high {
            background: #ef4444;
            color: #fff;
        }
        
        .note-actions {
            display: flex;
            gap: 4px;
        }
        
        .note-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .note-btn:hover {
            background: rgba(0,0,0,0.1);
        }
        
        .note-title {
            font-weight: 600;
            color: #111;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .note-content {
            color: #374151;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        
        .note-timestamp {
            font-size: 11px;
            color: #9ca3af;
        }
        
        .notes-search {
            margin-bottom: 16px;
        }
        
        .notes-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Archivo', Arial, sans-serif;
        }
        
        .notes-search input:focus {
            outline: none;
            border-color: #0700ff;
            box-shadow: 0 0 0 2px #e2fc0b44;
        }
        
        .notes-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .filter-chip {
            padding: 4px 12px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        
        .filter-chip:hover {
            background: #e5e7eb;
        }
        
        .filter-chip.active {
            background: #0700ff;
            color: #fff;
            border-color: #0700ff;
        }
        
        .notes-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        
        .notes-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        /* FLOATING NOTES */
        .floating-notes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 500;
        }
        
        .floating-note {
            position: absolute;
            width: 200px;
            min-height: 120px;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: move;
            pointer-events: auto;
            resize: both;
            overflow: auto;
            min-width: 150px;
            max-width: 300px;
            min-height: 100px;
            max-height: 400px;
        }
        
        .floating-note.dragging {
            transform: rotate(3deg);
            z-index: 1000;
        }
        
        .floating-note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .floating-note-title {
            font-weight: 600;
            font-size: 12px;
            color: #92400e;
        }
        
        .floating-note-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #92400e;
            padding: 2px;
            border-radius: 2px;
            transition: background 0.2s;
        }
        
        .floating-note-close:hover {
            background: rgba(0,0,0,0.1);
        }
        
        .floating-note-content {
            font-size: 12px;
            line-height: 1.3;
            color: #92400e;
            word-wrap: break-word;
        }
        
        /* LIST VIEW STYLES */
        .projects-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .list-view-header {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 16px;
        }
        
        .list-view-title {
            font-size: 1.2rem;
            font-family: 'Abril Fatface', serif;
            color: #0700ff;
            margin-bottom: 8px;
        }
        
        .list-view-stats {
            display: flex;
            gap: 24px;
            font-size: 14px;
            color: #64748b;
        }
        
        .list-item {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .list-item:hover {
            border-color: #0700ff;
            box-shadow: 0 4px 12px rgba(7,0,255,0.1);
            transform: translateX(4px);
        }
        
        .list-item.focused {
            border-color: #0700ff;
            background: linear-gradient(90deg, #e2fc0b22 0%, #fff 100%);
        }
        
        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .list-item-info {
            flex: 1;
        }
        
        .list-item-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0700ff;
            margin-bottom: 4px;
            font-family: 'Archivo', Arial, sans-serif;
        }
        
        .list-item-client {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .list-item-context {
            font-size: 13px;
            color: #374151;
            line-height: 1.4;
            margin-bottom: 12px;
        }
        
        .list-item-meta {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .list-item-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .list-progress-bar {
            width: 100px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .list-progress-fill {
            height: 100%;
            background: #0700ff;
            transition: width 0.5s ease;
        }
        
        .list-progress-fill.focused {
            background: #f50a68;
        }
        
        .list-item-deadline {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .list-item-deadline.overdue {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .list-item-deadline.due-today {
            background: #fef3c7;
            color: #d97706;
        }
        
        .list-item-deadline.due-soon {
            background: #fef3c7;
            color: #f59e0b;
        }
        
        .list-item-deadline.due-later {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .list-item-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .list-item-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .list-item:hover .list-item-actions {
            opacity: 1;
        }
        
        /* KANBAN VIEW STYLES */
        .projects-kanban {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
            min-height: 400px;
        }
        
        .kanban-column {
            min-width: 220px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .kanban-title {
            font-size: 1rem;
            font-weight: 600;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .kanban-count {
            background: #0700ff;
            color: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .kanban-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 200px;
        }
        
        .kanban-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.07);
        }
        
        .kanban-card:hover {
            border-color: #0700ff;
            box-shadow: 0 4px 12px rgba(7,0,255,0.10);
            transform: translateY(-2px);
        }
        
        .kanban-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #0700ff;
            margin-bottom: 2px;
        }
        
        .kanban-card-client {
            font-size: 12px;
            color: #64748b;
        }
        
        .kanban-card-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0;
        }
        
        .kanban-progress-bar {
            flex: 1;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .kanban-progress-fill {
            height: 100%;
            background: #0700ff;
            transition: width 0.5s ease;
        }
        
        .kanban-progress-text {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
        }
        
        .kanban-card-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }
        
        .kanban-tag {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
            background: #e2fc0b;
            color: #0700ff;
        }
        
        .kanban-card-deadline {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .kanban-card-deadline.overdue {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .kanban-card-deadline.due-today {
            background: #fef3c7;
            color: #d97706;
        }
        
        .kanban-card-deadline.due-soon {
            background: #fef3c7;
            color: #f59e0b;
        }
        
        .kanban-card-deadline.due-later {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .kanban-column.drag-over {
            background: #e2fc0b22;
            border-color: #0700ff;
        }
        
        .kanban-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .kanban-empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        /* VIEW FILTER BAR */
        .view-filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
        }
        
        .view-search {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .view-search-input {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 14px;
            min-width: 200px;
            font-family: 'Archivo', Arial, sans-serif;
        }
        
        .view-search-input:focus {
            outline: none;
            border-color: #0700ff;
            box-shadow: 0 0 0 2px #e2fc0b44;
        }
        
        .view-sort {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .view-sort-select {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 14px;
            background: #fff;
            font-family: 'Archivo', Arial, sans-serif;
        }
        
        .view-sort-select:focus {
            outline: none;
            border-color: #0700ff;
        }

        /* TAGS - Restored from earlier */
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
            animation: fadeIn 0.2s ease-out;
        }
        
        .tag-client { background: #e2fc0b; color: #0700ff; }
        .tag-priority { background: #f50a68; color: #fff; }
        .tag-status { background: #0700ff; color: #fff; }
        .tag-type { background: #10b981; color: #fff; }
        .tag-custom { background: #8b5cf6; color: #fff; }

        /* Responsive Design */
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-overlay.hidden {
            display: none;
        }
        .modal-content {
            background: #fff;
            border-radius: 18px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(7,0,255,0.10);
            position: relative;
            z-index: 1001;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 24px 0 24px;
            border-bottom: 1px solid #eee;
            margin-bottom: 24px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-family: 'Abril Fatface', serif;
            font-weight: 400;
            color: #0700ff;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #888;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s, color 0.2s;
        }
        .modal-close:hover {
            background: #e2fc0b44;
            color: #0700ff;
        }
        .modal-body {
            padding: 0 24px 24px 24px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px 24px 24px;
            border-top: 1px solid #eee;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #0700ff;
            font-family: 'Archivo', Arial, sans-serif;
        }
        .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #0700ff;
            border-radius: 10px;
            font-size: 15px;
            font-family: 'Archivo', Arial, sans-serif;
            transition: border 0.2s;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #f50a68;
            box-shadow: 0 0 0 2px #e2fc0b44;
        }
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-row {
            display: flex;
            gap: 16px;
        }
        .form-row .form-group {
            flex: 1;
        }
        
        /* Task button styling */
        .task-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s, color 0.2s, transform 0.2s;
            color: #0700ff;
            font-size: 1.1rem;
        }
        .task-btn:hover {
            background: #e2fc0b44;
            transform: scale(1.1);
        }
        .task-btn.active {
            color: #f50a68;
        }
        .task-btn.priority {
            color: #f50a68;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .dashboard-metrics {
                grid-template-columns: 1fr;
            }
            
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .project-detail-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .project-detail-title-group {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }
            
            .project-detail-actions {
                justify-content: center;
            }
            
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
            
            .project-detail-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .breadcrumb {
                flex-wrap: wrap;
            }
            
            .notes-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .floating-note {
                width: 180px;
                min-height: 100px;
            }
            
            .form-row {
                flex-direction: column;
            }
        }
        
        /* SIDEBAR STYLES */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 200px;
            height: 100vh;
            background: #fff;
            box-shadow: 2px 0 12px rgba(7,0,255,0.06);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            z-index: 1100;
            padding-top: 24px;
            padding-left: 16px;
        }
        .sidebar-logo {
            margin-bottom: 32px;
            width: 100%;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }
        .sidebar-logo img {
            height: 48px;
            width: auto;
            display: block;
        }
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }
        .sidebar-link {
            background: none;
            border: none;
            color: #0700ff;
            width: 100%;
            padding: 14px 0 14px 12px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-family: 'Archivo', Arial, sans-serif;
            font-weight: 600;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            text-align: left;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background: #0700ff;
            color: #fff;
        }
        .sidebar-icon {
            font-size: 1.5rem;
        }
        @media (max-width: 900px) {
            .sidebar {
                width: 60px;
                padding-top: 12px;
                padding-left: 0;
            }
            .sidebar-link span:last-child {
                display: none;
            }
        }
        .container {
            margin-left: 200px;
        }
        @media (max-width: 900px) {
            .container {
                margin-left: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <img src="assets/icon.png" alt="App Logo" />
        </div>
        <nav class="sidebar-nav">
            <button class="sidebar-link" id="sidebar-home" onclick="window.taskManager && window.taskManager.navigateToHome && window.taskManager.navigateToHome()">
                <span class="sidebar-icon">🏠</span>
                <span>Home</span>
            </button>
            <button class="sidebar-link" id="sidebar-projects" onclick="window.taskManager && window.taskManager.showAllProjects && window.taskManager.showAllProjects()">
                <span class="sidebar-icon">📁</span>
                <span>All Projects</span>
            </button>
            <button class="sidebar-link" id="sidebar-notes" onclick="window.taskManager && window.taskManager.toggleNotesSidebar && window.taskManager.toggleNotesSidebar()">
                <span class="sidebar-icon">📝</span>
                <span>Notes</span>
            </button>
        </nav>
    </div>
    <div class="container">
        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb" id="breadcrumb">
            <div class="breadcrumb-item">
                <span class="breadcrumb-link" onclick="window.taskManager.navigateToHome()">🏠 Dashboard</span>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view">
            <div class="header">
                <h1 class="title">Task Manager</h1>
                <p class="date" id="current-date"></p>
            </div>

            <!-- Dashboard Metrics -->
            <div class="dashboard-metrics" id="dashboard-metrics">
                <!-- Metrics will be rendered here -->
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2 class="quick-actions-title">
                    <span>⚡</span> Quick Actions
                </h2>
                <div class="quick-actions-grid">
                    <button class="quick-action-btn" onclick="window.taskManager.showAddProjectModal()">
                        <span class="quick-action-icon">➕</span>
                        <span>New Project</span>
                    </button>
                    <button class="quick-action-btn" onclick="window.taskManager.toggleNotesSidebar()">
                        <span class="quick-action-icon">📝</span>
                        <span>Add Note</span>
                    </button>
                    <button class="quick-action-btn" onclick="window.taskManager.showDeadlineOverview()">
                        <span class="quick-action-icon">⏰</span>
                        <span>View Deadlines</span>
                    </button>
                    <button class="quick-action-btn" onclick="window.taskManager.exportAllData()">
                        <span class="quick-action-icon">📤</span>
                        <span>Export Data</span>
                    </button>
                </div>
            </div>

            <div class="focus-banner hidden" id="focus-banner">
                <h3 id="focus-title">Today's Focus Project</h3>
                <p id="focus-context">Project context will appear here</p>
            </div>

            <!-- Recent Activity -->
            <div class="activity-feed">
                <div class="activity-header">
                    <h2 class="activity-title">
                        <span>📈</span> Recent Activity
                    </h2>
                    <div class="project-switcher">
                        <button class="project-switcher-btn" onclick="window.taskManager.toggleProjectSwitcher()">
                            <span>🔄</span> Switch Project <span>▼</span>
                        </button>
                        <div class="project-switcher-dropdown hidden" id="project-switcher-dropdown">
                            <!-- Project list will be rendered here -->
                        </div>
                    </div>
                </div>
                <div id="activity-list">
                    <!-- Activity items will be rendered here -->
                </div>
            </div>

            <!-- View Filter Bar -->
            <div class="view-filter-bar" id="view-filter-bar">
                <div class="view-search">
                    <span>🔍</span>
                    <input type="text" class="view-search-input" id="view-search-input" placeholder="Search projects...">
                </div>
                <div class="view-sort">
                    <span>Sort:</span>
                    <select class="view-sort-select" id="view-sort-select">
                        <option value="name">Name</option>
                        <option value="progress">Progress</option>
                        <option value="deadline">Deadline</option>
                        <option value="client">Client</option>
                        <option value="updated">Last Updated</option>
                    </select>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle">
                <button class="view-toggle-btn active" onclick="window.taskManager.setView('cards')">
                    <span>🃏</span> Cards
                </button>
                <button class="view-toggle-btn" onclick="window.taskManager.setView('list')">
                    <span>📋</span> List
                </button>
                <button class="view-toggle-btn" onclick="window.taskManager.setView('kanban')">
                    <span>📊</span> Kanban
                </button>
            </div>

            <!-- Projects Grid -->
            <div class="projects-grid" id="projects-container">
                <!-- Projects will be rendered here -->
            </div>
        </div>

        <!-- Project Detail View -->
        <div id="project-detail-view" class="hidden">
            <!-- Project detail content will be rendered here -->
        </div>

        <!-- Notes Sidebar - Restored from Phase 3 -->
        <div class="notes-sidebar" id="notes-sidebar">
            <div class="notes-header">
                <h2 class="notes-title">📝 Notes & Reminders</h2>
                <button class="notes-close" id="notes-close">×</button>
            </div>
            
            <div class="notes-content">
                <!-- Quick Add Note -->
                <div class="add-note-section">
                    <textarea class="quick-note-input" id="quick-note-input" placeholder="Quick note or reminder..."></textarea>
                    <div class="note-controls">
                        <div class="color-picker">
                            <div class="color-option color-yellow selected" data-color="yellow" title="Yellow"></div>
                            <div class="color-option color-blue" data-color="blue" title="Blue"></div>
                            <div class="color-option color-pink" data-color="pink" title="Pink"></div>
                            <div class="color-option color-green" data-color="green" title="Green"></div>
                            <div class="color-option color-orange" data-color="orange" title="Orange"></div>
                            <div class="color-option color-purple" data-color="purple" title="Purple"></div>
                        </div>
                        <select class="priority-select" id="note-priority">
                            <option value="low">Low Priority</option>
                            <option value="medium">Medium Priority</option>
                            <option value="high">High Priority</option>
                        </select>
                        <button class="btn btn-primary" id="add-note-btn" style="padding: 6px 12px; font-size: 13px;">Add Note</button>
                        <button class="btn btn-outline" id="float-note-btn" style="padding: 6px 12px; font-size: 13px;" title="Create floating note">📌 Float</button>
                    </div>
                </div>
                
                <!-- Search and Filter -->
                <div class="notes-search">
                    <input type="text" placeholder="Search notes..." id="notes-search-input">
                </div>
                
                <div class="notes-filter">
                    <div class="filter-chip active" data-filter="all">All</div>
                    <div class="filter-chip" data-filter="high">High Priority</div>
                    <div class="filter-chip" data-filter="medium">Medium Priority</div>
                    <div class="filter-chip" data-filter="low">Low Priority</div>
                </div>
                
                <!-- Notes List -->
                <div class="notes-list" id="notes-list">
                    <div class="notes-empty">
                        <div class="notes-empty-icon">📝</div>
                        <p>No notes yet. Create your first note above!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Notes Container -->
        <div class="floating-notes" id="floating-notes"></div>
        
        <!-- Edit Task Modal -->
        <div class="modal-overlay hidden" id="edit-task-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Task</h2>
                    <button class="modal-close" id="close-edit-task-modal">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit-task-text">Task Description</label>
                        <textarea id="edit-task-text" class="form-textarea" placeholder="Enter task description" style="min-height: 60px;"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-task-deadline">Deadline</label>
                            <input type="date" id="edit-task-deadline" class="form-input">
                            <small style="color: #6b7280; font-size: 12px;">Leave empty to remove deadline</small>
                        </div>
                        <div class="form-group">
                            <label for="edit-task-priority">Priority</label>
                            <select id="edit-task-priority" class="form-input">
                                <option value="false">Normal</option>
                                <option value="true">Daily Priority ⭐</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-task-status">Status</label>
                            <select id="edit-task-status" class="form-input">
                                <option value="not-started">📝 Not Started</option>
                                <option value="in-progress">🚀 In Progress</option>
                                <option value="review">👀 Review</option>
                                <option value="completed">✅ Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-task-tags">Tags (comma-separated)</label>
                        <input type="text" id="edit-task-tags" class="form-input" placeholder="e.g. urgent, research, client">
                        <small style="color: #6b7280; font-size: 12px;">Add tags separated by commas</small>
                    </div>
                    <div class="form-group">
                        <label>Task Status</label>
                        <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; color: #111;">
                                <input type="checkbox" id="edit-task-completed" class="checkbox">
                                Mark as completed
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-edit-task">Cancel</button>
                    <button class="btn btn-danger" id="delete-task-btn" style="margin-right: auto;">Delete Task</button>
                    <button class="btn btn-primary" id="save-task">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Edit Project Modal -->
        <div class="modal-overlay hidden" id="edit-project-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Project</h2>
                    <button class="modal-close" id="close-edit-project-modal">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit-project-name">Project Name</label>
                        <input type="text" id="edit-project-name" class="form-input" placeholder="Enter project name">
                    </div>
                    <div class="form-group">
                        <label for="edit-project-client">Client</label>
                        <input type="text" id="edit-project-client" class="form-input" placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label for="edit-project-deadline">Project Deadline</label>
                        <input type="date" id="edit-project-deadline" class="form-input">
                        <small style="color: #6b7280; font-size: 12px;">Leave empty to remove deadline</small>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-status">Project Status</label>
                        <select id="edit-project-status" class="form-input">
                            <option value="not-started">🎯 Not Started</option>
                            <option value="in-progress">🚀 In Progress</option>
                            <option value="review">👀 Review</option>
                            <option value="completed">✅ Completed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-context">Context</label>
                        <textarea id="edit-project-context" class="form-textarea" placeholder="Describe the project context and goals"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-tags">Tags (comma-separated)</label>
                        <input type="text" id="edit-project-tags" class="form-input" placeholder="e.g. urgent, design, frontend">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-edit-project">Cancel</button>
                    <button class="btn btn-danger" id="delete-project-btn" style="margin-right: auto;">Delete Project</button>
                    <button class="btn btn-primary" id="save-project">Save Changes</button>
                </div>
            </div>
        </div>
        
        <!-- Add Project Modal -->
        <div class="modal-overlay hidden" id="add-project-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add New Project</h2>
                    <button class="modal-close" id="close-add-project-modal">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="add-project-name">Project Name</label>
                        <input type="text" id="add-project-name" class="form-input" placeholder="Enter project name">
                    </div>
                    <div class="form-group">
                        <label for="add-project-client">Client</label>
                        <input type="text" id="add-project-client" class="form-input" placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label for="add-project-deadline">Project Deadline (optional)</label>
                        <input type="date" id="add-project-deadline" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="add-project-status">Project Status</label>
                        <select id="add-project-status" class="form-input">
                            <option value="not-started">🎯 Not Started</option>
                            <option value="in-progress">🚀 In Progress</option>
                            <option value="review">👀 Review</option>
                            <option value="completed">✅ Completed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="add-project-context">Context</label>
                        <textarea id="add-project-context" class="form-textarea" placeholder="Describe the project context and goals"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="add-project-tags">Tags (comma-separated)</label>
                        <input type="text" id="add-project-tags" class="form-input" placeholder="e.g. urgent, design, frontend">
                        <small style="color: #6b7280; font-size: 12px;">Add tags separated by commas. Tags help organize and filter projects.</small>
                    </div>
                    <div class="form-group">
                        <label for="add-initial-tasks">Initial Tasks (optional)</label>
                        <textarea id="add-initial-tasks" class="form-textarea" placeholder="Enter initial tasks, one per line"></textarea>
                        <small style="color: #6b7280; font-size: 12px;">You can add tasks later, or enter them now separated by new lines</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-add-project">Cancel</button>
                    <button class="btn btn-primary" id="create-project">Create Project</button>
                </div>
            </div>
        </div>

        <!-- Add Task Modal -->
        <div class="modal hidden" id="add-task-modal">
          <div class="modal-content" style="max-width: 480px; border-radius: 24px;">
            <div class="modal-header" style="border-bottom: 1.5px solid #e5e7eb;">
              <h2 style="font-family: 'Abril Fatface', serif; color: #0700ff; font-size: 2rem; margin: 0;">Add New Task</h2>
              <button class="close" id="close-add-task-modal" style="font-size: 1.3rem; border: none; background: none; color: #222; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px 0 0 0; display: flex; flex-direction: column; gap: 18px;">
              <div class="form-group">
                <label for="add-task-text" style="font-weight: 600; color: #0700ff; margin-bottom: 6px;">Task Description</label>
                <input type="text" id="add-task-text" class="input" placeholder="Task description" autofocus style="border: 1.5px solid #0700ff; border-radius: 12px; padding: 10px; font-size: 1rem;" />
              </div>
              <div class="form-group">
                <label for="add-task-tags" style="font-weight: 600; color: #0700ff; margin-bottom: 6px;">Tags (comma-separated)</label>
                <input type="text" id="add-task-tags" class="input" placeholder="e.g. bugfix, urgent" style="border: 1.5px solid #0700ff; border-radius: 12px; padding: 10px; font-size: 1rem;" />
              </div>
              <div class="form-group">
                <label for="add-task-status" style="font-weight: 600; color: #0700ff; margin-bottom: 6px;">Status</label>
                <select id="add-task-status" class="input" style="border: 1.5px solid #0700ff; border-radius: 12px; padding: 10px; font-size: 1rem;">
                    <option value="not-started">📝 Not Started</option>
                    <option value="in-progress">🚀 In Progress</option>
                    <option value="review">👀 Review</option>
                    <option value="completed">✅ Completed</option>
                </select>
              </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 16px; padding: 24px 0 0 0;">
              <button class="btn btn-secondary" id="cancel-add-task" style="border-radius: 16px; font-size: 1.1rem; padding: 10px 32px;">Cancel</button>
              <button class="btn btn-primary" id="save-add-task" style="border-radius: 16px; font-size: 1.1rem; padding: 10px 32px;">Add Task</button>
            </div>
          </div>
        </div>
    </div>

    <script>
        // Enhanced Task Manager with Navigation and Detail Views
        class TaskManager {
            constructor() {
                this.projects = [];
                this.focusProject = null;
                this.dailyPriorities = [];
                this.showFocusMode = false;
                this.autoSaveEnabled = true;
                this.allTags = new Set();
                
                // Navigation state
                this.currentView = 'dashboard'; // 'dashboard' or 'project-detail'
                this.currentProjectId = null;
                this.viewMode = 'cards'; // 'cards', 'list', 'kanban'
                this.taskFilter = 'all'; // 'all', 'active', 'completed'
                
                // Activity tracking
                this.activityLog = [];
                
                // Modal editing state
                this.editingProjectId = null;
                this.editingTaskId = null;
                this.editingTaskProjectId = null;
                
                // Notes system - Restored from Phase 3
                this.notes = [];
                this.floatingNotes = [];
                this.showNotes = false;
                this.selectedNoteColor = 'yellow';
                this.notesFilter = 'all';
                this.notesSearch = '';

                // Task search
                this.taskSearch = '';
                
                // View filtering and sorting
                this.viewSearch = '';
                this.viewSort = 'name';
                
                // Check if running in Electron
                this.isElectron = window.electronAPI && window.electronAPI.isElectron;

                this.basePath = '';
                if (this.isElectron) {
                    window.electronAPI.getUserDataPath().then(p => {
                        this.basePath = p;
                        this.loadExistingData();
                    });
                    this.setupMenuHandlers();
                } else {
                    this.basePath = '/tmp';
                }
                
                this.initializeProjects();
                this.initializeNotes();
                this.generateActivityLog();
                this.setupEventListeners();
                this.setupKeyboardShortcuts();
                
                this.render();
                this.setupAutoSave();
            }
            
            initializeNotes() {
                this.notes = [
                    {
                        id: 1,
                        title: 'Welcome Note',
                        content: 'Welcome to the enhanced task manager! You can now create notes and reminders to keep track of important information.',
                        color: 'blue',
                        priority: 'medium',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        title: 'BMW Meeting',
                        content: 'Remember to prepare the dashboard mockups for tomorrow\'s client presentation. Focus on the segment-level analytics.',
                        color: 'yellow',
                        priority: 'high',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                this.floatingNotes = [
                    {
                        id: 1,
                        title: 'Quick Reminder',
                        content: 'Check email for client feedback on R 12 G/S insights',
                        position: { x: 50, y: 100 },
                        size: { width: 200, height: 120 }
                    }
                ];
            }
            
            initializeProjects() {
                this.projects = [
                    {
                        id: 1,
                        name: "Social Intelligence Dashboard - Merge Project",
                        client: "BMW Motorrad",
                        context: "Find a way to merge the existing Segment Level Dashboards and Product/Model Level dashboards into one project without over complicating and over delivering",
                        deadline: "2025-01-15",
                        status: "in-progress",
                        tags: ["dashboard", "analytics", "urgent", "merge"],
                        tasks: [
                            { id: 1, text: "Collect main points from mine and Katie's conversation about having a segment level throughout the full year for all segments, and add a product level section for relevant segments for certain models dependent on SOC's, Launches and priorities.", completed: false, deadline: "2025-01-08", tags: ["meeting", "planning"], status: 'not-started' },
                            { id: 2, text: "Complete Product Development process for this product to gather user stories, functional spec etc.", completed: true, deadline: "2025-01-12", tags: ["development", "documentation"], status: 'completed' },
                            { id: 3, text: "Create final presentation explaining what, why, how.", completed: false, deadline: "2025-01-15", tags: ["presentation", "client"], status: 'not-started' }
                        ]
                    },
                    {
                        id: 2,
                        name: "Social Intelligence Dashboard - R 12 G/S Insights",
                        client: "BMW Motorrad",
                        context: "Complete the R 12 G/S consumer insights tab for France and Italy.",
                        deadline: "2025-01-10",
                        status: "review",
                        tags: ["dashboard", "insights", "international"],
                        tasks: [
                            { id: 1, text: "Improve the AI Insight Generation by adjusting model in prompt to o3", completed: true, deadline: "2025-01-07", tags: ["ai", "optimization"], status: 'completed' },
                            { id: 2, text: "Share with wider team and client", completed: false, deadline: "2025-01-10", tags: ["sharing", "client"], status: 'not-started' }
                        ]
                    },
                    {
                        id: 3,
                        name: "Knowledge Base",
                        client: "Zeno",
                        context: "Tasked with creating a user functionality for the Knowledge Base in order to have users with different level of access",
                        deadline: "2025-02-01",
                        status: "in-progress",
                        tags: ["knowledge-base", "user-management", "access-control"],
                        tasks: [
                            { id: 1, text: "Get access to Github repo", completed: true, deadline: "2025-01-06", tags: ["access", "github"], status: 'completed' },
                            { id: 2, text: "Set-up test branch", completed: false, deadline: "2025-01-08", tags: ["git", "testing"], status: 'not-started' },
                            { id: 3, text: "Set up Supabase Pro account with registrations@", completed: false, deadline: "2025-01-10", tags: ["database", "setup"], status: 'not-started' },
                            { id: 4, text: "Update Supabase MCP in Cursor with new personal token key.", completed: false, deadline: "2025-01-12", tags: ["configuration", "api"], status: 'not-started' },
                            { id: 5, text: "Create new database for users (view only, standard, admin)", completed: false, deadline: "2025-01-28", tags: ["database", "permissions"], status: 'not-started' }
                        ]
                    },
                    {
                        id: 4,
                        name: "Admin Tasks",
                        client: "Internal",
                        context: "Administrative tasks and general business operations",
                        deadline: null,
                        status: "not-started",
                        tags: ["admin", "business", "operations"],
                        tasks: [
                            { id: 1, text: "Send Harriet Receipts", completed: true, deadline: "2025-01-05", tags: ["finance", "receipts"], status: 'completed' },
                            { id: 2, text: "Update AI Tool Sheet", completed: false, deadline: null, tags: ["documentation", "tools"], status: 'not-started' }
                        ]
                    },
                    {
                        id: 'retailer-toolkit',
                        name: 'Retailer Toolkit',
                        client: 'BMW Motorrad',
                        color: '#e2fc0b',
                        context: "Find a solution to why some users can log in and others cant",
                        tags: ['toolkit', 'bugfix', 'authentication'],
                        tasks: [
                            {
                                id: 'rt-1',
                                text: 'Create main-backup branch',
                                completed: false,
                                tags: ['git', 'backup'],
                                priority: 'normal',
                                status: 'not-started'
                            },
                            {
                                id: 'rt-2',
                                text: 'Remove all added security to Login functionality via Codex.',
                                completed: false,
                                tags: ['security', 'login'],
                                priority: 'normal',
                                status: 'not-started'
                            },
                            {
                                id: 'rt-3',
                                text: "Test with user who can't currently log in",
                                completed: false,
                                tags: ['testing', 'user'],
                                priority: 'normal',
                                status: 'not-started'
                            }
                        ]
                    }
                ];
                
                this.focusProject = 3; // Focus on Zeno project
                this.dailyPriorities = ['1-1', '3-2', '3-3']; // Some priority tasks
                this.updateAllTags();
            }
            
            generateActivityLog() {
                const now = new Date();
                this.activityLog = [
                    {
                        id: 1,
                        type: 'completed',
                        icon: '✅',
                        description: 'Completed task: Get access to Github repo',
                        project: 'Knowledge Base',
                        projectId: 3,
                        time: new Date(now.getTime() - 1000 * 60 * 30) // 30 minutes ago
                    },
                    {
                        id: 2,
                        type: 'completed',
                        icon: '✅',
                        description: 'Completed task: Complete Product Development process',
                        project: 'Social Intelligence Dashboard - Merge Project',
                        projectId: 1,
                        time: new Date(now.getTime() - 1000 * 60 * 60 * 2) // 2 hours ago
                    },
                    {
                        id: 3,
                        type: 'created',
                        icon: '➕',
                        description: 'Added new task to Admin Tasks',
                        project: 'Admin Tasks',
                        projectId: 4,
                        time: new Date(now.getTime() - 1000 * 60 * 60 * 4) // 4 hours ago
                    },
                    {
                        id: 4,
                        type: 'overdue',
                        icon: '⚠️',
                        description: 'Task overdue: Set-up test branch',
                        project: 'Knowledge Base',
                        projectId: 3,
                        time: new Date(now.getTime() - 1000 * 60 * 60 * 24) // 1 day ago
                    }
                ];
            }
            
            setupEventListeners() {
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'h':
                                e.preventDefault();
                                this.navigateToHome();
                                break;
                            case 'n':
                                e.preventDefault();
                                this.showAddProjectModal();
                                break;
                            case 'f':
                                e.preventDefault();
                                this.toggleFilters();
                                break;
                        }
                    }
                    
                    if (e.key === 'Escape') {
                        if (this.currentView === 'project-detail') {
                            this.navigateToHome();
                        }
                    }
                });
                
                // Click outside to close project switcher
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.project-switcher')) {
                        document.getElementById('project-switcher-dropdown').classList.add('hidden');
                    }
                });
                
                // Notes event listeners - Restored from Phase 3
                document.getElementById('notes-close').addEventListener('click', () => {
                    this.toggleNotesSidebar();
                });
                
                document.getElementById('add-note-btn').addEventListener('click', () => {
                    this.addNoteFromInput();
                });
                
                document.getElementById('float-note-btn').addEventListener('click', () => {
                    this.addFloatingNoteFromInput();
                });
                
                document.getElementById('quick-note-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        this.addNoteFromInput();
                    }
                });
                
                // Color picker
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        this.selectedNoteColor = option.dataset.color;
                    });
                });
                
                // Notes filter
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.addEventListener('click', () => {
                        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                        this.notesFilter = chip.dataset.filter;
                        this.renderNotes();
                    });
                });
                
                document.getElementById('notes-search-input').addEventListener('input', (e) => {
                    this.notesSearch = e.target.value;
                    this.renderNotes();
                });
                
                // View filtering and sorting event listeners
                document.getElementById('view-search-input').addEventListener('input', (e) => {
                    this.viewSearch = e.target.value;
                    this.renderProjectsGrid();
                });
                
                document.getElementById('view-sort-select').addEventListener('change', (e) => {
                    this.viewSort = e.target.value;
                    this.renderProjectsGrid();
                });
                
                // Modal event listeners - Restored from Phase 3
                this.setupModalEventListeners();
            }
            
            setupModalEventListeners() {
                // Edit Task Modal
                document.getElementById('close-edit-task-modal').addEventListener('click', () => {
                    this.hideEditTaskModal();
                });
                
                document.getElementById('cancel-edit-task').addEventListener('click', () => {
                    this.hideEditTaskModal();
                });
                
                document.getElementById('save-task').addEventListener('click', () => {
                    this.saveTaskChanges();
                });
                
                document.getElementById('delete-task-btn').addEventListener('click', () => {
                    this.deleteTaskFromModal();
                });
                
                // Edit Project Modal
                document.getElementById('close-edit-project-modal').addEventListener('click', () => {
                    this.hideEditProjectModal();
                });
                
                document.getElementById('cancel-edit-project').addEventListener('click', () => {
                    this.hideEditProjectModal();
                });
                
                document.getElementById('save-project').addEventListener('click', () => {
                    this.saveProjectChanges();
                });
                
                document.getElementById('delete-project-btn').addEventListener('click', () => {
                    this.deleteProject();
                });
                
                // Add Project Modal
                document.getElementById('close-add-project-modal').addEventListener('click', () => {
                    this.hideAddProjectModal();
                });
                
                document.getElementById('cancel-add-project').addEventListener('click', () => {
                    this.hideAddProjectModal();
                });
                
                document.getElementById('create-project').addEventListener('click', () => {
                    this.createNewProject();
                });
                
                // Close modals when clicking outside
                document.getElementById('edit-task-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'edit-task-modal') {
                        this.hideEditTaskModal();
                    }
                });
                
                document.getElementById('edit-project-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'edit-project-modal') {
                        this.hideEditProjectModal();
                    }
                });
                
                document.getElementById('add-project-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'add-project-modal') {
                        this.hideAddProjectModal();
                    }
                });
                
                // Add escape key handler for modals
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });

                // Add Task Modal
                document.getElementById('close-add-task-modal').addEventListener('click', () => {
                  this.hideAddTaskModal();
                });
                document.getElementById('cancel-add-task').addEventListener('click', () => {
                  this.hideAddTaskModal();
                });
                document.getElementById('save-add-task').addEventListener('click', () => {
                  this.saveAddTask();
                });
            }
            
            setupKeyboardShortcuts() {
                // Show keyboard shortcuts on first load
                this.showToast('💡 Keyboard shortcuts: Ctrl+H (Home), Ctrl+N (New Project), Ctrl+F (Filters), Esc (Back)', 'info');
            }

            setupMenuHandlers() {
                if (!this.isElectron) return;

                window.electronAPI.onMenuNewProject(() => {
                    this.showAddProjectModal();
                });

                window.electronAPI.onMenuSaveAll(() => {
                    this.saveAllFiles();
                });

                window.electronAPI.onMenuToggleFocus(() => {
                    this.showFocusMode = !this.showFocusMode;
                    this.render();
                });

                window.electronAPI.onExportData(async (event, filePath) => {
                    await this.exportAllData(filePath);
                });
            }
            
            setupAutoSave() {
                setInterval(() => {
                    if (this.autoSaveEnabled) {
                        this.triggerAutoSave();
                    }
                }, 3000);
            }
            
            async triggerAutoSave() {
                try {
                    if (this.isElectron) {
                        await this.saveAllFiles(true);
                    }
                } catch (error) {
                    console.error('Auto-save failed:', error);
                }
            }
            
            async loadExistingData() {
                if (!this.isElectron || !this.basePath) return;
                try {
                    const dataPath = `${this.basePath}/task-manager-data.json`;
                    const result = await window.electronAPI.readFile(dataPath);
                    if (result.success) {
                        const data = JSON.parse(result.content);
                        this.projects = data.projects || this.projects;
                        this.notes = data.notes || this.notes;
                        this.floatingNotes = data.floatingNotes || this.floatingNotes;
                        this.focusProject = data.focusProject ?? this.focusProject;
                        this.dailyPriorities = data.dailyPriorities || this.dailyPriorities;
                        this.render();
                        this.showToast('✅ Loaded existing data!', 'success');
                    }
                } catch (error) {
                    console.log('No existing data found, using defaults');
                }
            }

            async saveAllFiles(silent = false) {
                if (!this.isElectron || !this.basePath) return;
                try {
                    const data = {
                        projects: this.projects,
                        notes: this.notes,
                        floatingNotes: this.floatingNotes,
                        focusProject: this.focusProject,
                        dailyPriorities: this.dailyPriorities,
                        lastSaved: new Date().toISOString()
                    };
                    const dataPath = `${this.basePath}/task-manager-data.json`;
                    const result = await window.electronAPI.writeFile(dataPath, JSON.stringify(data, null, 2));
                    if (!result.success) throw new Error(result.error);
                    if (!silent) {
                        this.showToast('💾 Data saved successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Save failed:', error);
                    if (!silent) {
                        this.showToast('❌ Save failed: ' + error.message, 'error');
                    }
                }
            }
            
            updateAllTags() {
                this.allTags.clear();
                this.projects.forEach(project => {
                    if (project.tags) {
                        project.tags.forEach(tag => this.allTags.add(tag));
                    }
                    if (project.tasks) {
                        project.tasks.forEach(task => {
                            if (task.tags) {
                                task.tags.forEach(tag => this.allTags.add(tag));
                            }
                        });
                    }
                });
            }
            
            // NAVIGATION METHODS
            navigateToHome() {
                this.currentView = 'dashboard';
                document.getElementById('dashboard-view').style.display = 'block';
                document.getElementById('project-detail-view').style.display = 'none';
                let allProjectsView = document.getElementById('all-projects-view');
                if (allProjectsView) allProjectsView.style.display = 'none';
                this.render();
            }
            
            navigateToProject(projectId) {
                // Hide or remove the all-projects-view div if it exists
                const allProjectsView = document.getElementById('all-projects-view');
                if (allProjectsView) allProjectsView.style.display = 'none';
                this.currentView = 'project-detail';
                this.currentProjectId = projectId;
                this.render();
                // Removed history.pushState - not supported in iframe
            }
            
            setView(view) {
                this.viewMode = view;
                document.querySelectorAll('.view-toggle-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                this.renderProjectsGrid();
            }
            
            getFilteredAndSortedProjects() {
                let projects = [...this.projects];
                
                // Apply search filter
                if (this.viewSearch) {
                    const search = this.viewSearch.toLowerCase();
                    projects = projects.filter(project =>
                        project.name.toLowerCase().includes(search) ||
                        project.client.toLowerCase().includes(search) ||
                        project.context.toLowerCase().includes(search) ||
                        (project.tags && project.tags.some(tag => tag.toLowerCase().includes(search)))
                    );
                }

                if (this.showFocusMode && this.focusProject) {
                    projects = projects.filter(p => String(p.id) === String(this.focusProject));
                }
                
                // Apply sorting
                projects.sort((a, b) => {
                    switch (this.viewSort) {
                        case 'name':
                            return a.name.localeCompare(b.name);
                        case 'client':
                            return a.client.localeCompare(b.client);
                        case 'progress':
                            const aProgress = a.tasks.length > 0 ? (a.tasks.filter(t => t.completed).length / a.tasks.length) : 0;
                            const bProgress = b.tasks.length > 0 ? (b.tasks.filter(t => t.completed).length / b.tasks.length) : 0;
                            return bProgress - aProgress;
                        case 'deadline':
                            const aDeadline = a.deadline ? new Date(a.deadline) : new Date('2099-12-31');
                            const bDeadline = b.deadline ? new Date(b.deadline) : new Date('2099-12-31');
                            return aDeadline - bDeadline;
                        case 'updated':
                            // For demo purposes, we'll use a simple metric
                            const aUpdated = a.tasks.filter(t => t.completed).length;
                            const bUpdated = b.tasks.filter(t => t.completed).length;
                            return bUpdated - aUpdated;
                        default:
                            return 0;
                    }
                });
                
                return projects;
            }
            
            toggleProjectSwitcher() {
                const dropdown = document.getElementById('project-switcher-dropdown');
                dropdown.classList.toggle('hidden');
                
                if (!dropdown.classList.contains('hidden')) {
                    this.renderProjectSwitcher();
                }
            }
            
            // RENDERING METHODS
            render() {
                this.renderDate();
                this.renderBreadcrumb();
                this.renderFocusBanner();

                if (this.currentView === 'dashboard') {
                    this.renderDashboard();
                } else if (this.currentView === 'project-detail') {
                    this.renderProjectDetail();
                }
            }
            
            renderDate() {
                const date = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const dateElement = document.getElementById('current-date');
                if (dateElement) {
                    dateElement.textContent = date;
                }
            }
            
            renderBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                
                if (this.currentView === 'dashboard') {
                    breadcrumb.innerHTML = `
                        <div class="breadcrumb-item">
                            <span class="breadcrumb-current">🏠 Dashboard</span>
                        </div>
                    `;
                } else if (this.currentView === 'project-detail') {
                    const project = this.projects.find(p => String(p.id) === String(this.currentProjectId));
                    breadcrumb.innerHTML = `
                        <div class="breadcrumb-item">
                            <span class="breadcrumb-link" onclick="window.taskManager.navigateToHome()">🏠 Dashboard</span>
                        </div>
                        <div class="breadcrumb-item">
                            <span class="breadcrumb-separator">›</span>
                            <span class="breadcrumb-current">📂 ${project ? project.name : 'Project'}</span>
                        </div>
                    `;
                }
            }

            renderFocusBanner() {
                const banner = document.getElementById('focus-banner');
                if (!banner) return;

                if (this.showFocusMode && this.focusProject) {
                    const focusedProject = this.projects.find(p => String(p.id) === String(this.focusProject));
                    if (focusedProject) {
                        banner.classList.remove('hidden');
                        banner.querySelector('#focus-title').textContent = `Today's Focus: ${focusedProject.name}`;
                        banner.querySelector('#focus-context').textContent = focusedProject.context || '';
                    }
                } else {
                    banner.classList.add('hidden');
                }
            }
            
            renderDashboard() {
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('project-detail-view').classList.add('hidden');
                
                this.renderDashboardMetrics();
                this.renderRecentActivity();
                this.renderProjectsGrid();
            }
            
            renderDashboardMetrics() {
                const container = document.getElementById('dashboard-metrics');
                const totalProjects = this.projects.length;
                const completedProjects = this.projects.filter(p => {
                    const completed = p.tasks.filter(t => t.completed).length;
                    return completed === p.tasks.length && p.tasks.length > 0;
                }).length;
                const totalTasks = this.projects.reduce((sum, p) => sum + p.tasks.length, 0);
                const completedTasks = this.projects.reduce((sum, p) => sum + p.tasks.filter(t => t.completed).length, 0);
                const overdueTasks = this.getOverdueTasks().length;
                const dueTodayTasks = this.getDueTodayTasks().length;
                
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                container.innerHTML = `
                    <div class="metric-card primary">
                        <div class="metric-header">
                            <div class="metric-icon">📊</div>
                        </div>
                        <div class="metric-value">${totalProjects}</div>
                        <div class="metric-label">Total Projects</div>
                        <div class="metric-change positive">
                            <span>↗</span> ${completedProjects} completed
                        </div>
                    </div>
                    
                    <div class="metric-card success">
                        <div class="metric-header">
                            <div class="metric-icon">✅</div>
                        </div>
                        <div class="metric-value">${completionRate}%</div>
                        <div class="metric-label">Completion Rate</div>
                        <div class="metric-change">
                            ${completedTasks}/${totalTasks} tasks done
                        </div>
                    </div>
                    
                    <div class="metric-card ${overdueTasks > 0 ? 'danger' : ''}">
                        <div class="metric-header">
                            <div class="metric-icon">⚠️</div>
                        </div>
                        <div class="metric-value">${overdueTasks}</div>
                        <div class="metric-label">Overdue Tasks</div>
                        <div class="metric-change ${overdueTasks > 0 ? 'negative' : ''}">
                            ${overdueTasks > 0 ? 'Needs attention' : 'All caught up!'}
                        </div>
                    </div>
                    
                    <div class="metric-card ${dueTodayTasks > 0 ? 'warning' : ''}">
                        <div class="metric-header">
                            <div class="metric-icon">📅</div>
                        </div>
                        <div class="metric-value">${dueTodayTasks}</div>
                        <div class="metric-label">Due Today</div>
                        <div class="metric-change">
                            ${dueTodayTasks > 0 ? 'Focus needed' : 'Clear schedule'}
                        </div>
                    </div>
                `;
            }
            
            renderRecentActivity() {
                const container = document.getElementById('activity-list');
                
                if (this.activityLog.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #9ca3af;">
                            <div style="font-size: 48px; margin-bottom: 16px;">📈</div>
                            <p>No recent activity</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                this.activityLog.slice(0, 5).forEach(activity => {
                    const timeAgo = this.getTimeAgo(activity.time);
                    
                    const item = document.createElement('div');
                    item.className = 'activity-item';
                    item.innerHTML = `
                        <div class="activity-icon ${activity.type}">
                            ${activity.icon}
                        </div>
                        <div class="activity-content">
                            <div class="activity-description">${activity.description}</div>
                            <div class="activity-project">in ${activity.project}</div>
                        </div>
                        <div class="activity-time">${timeAgo}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.navigateToProject(activity.projectId);
                    });
                    
                    container.appendChild(item);
                });
            }
            
            renderProjectsGrid() {
                const container = document.getElementById('projects-container');
                const projects = this.getFilteredAndSortedProjects();
                
                if (this.viewMode === 'cards') {
                    container.className = 'projects-grid';
                    container.innerHTML = '';
                    
                    projects.forEach(project => {
                        const card = this.createProjectCard(project);
                        container.appendChild(card);
                    });
                } else if (this.viewMode === 'list') {
                    this.renderListView(container, projects);
                } else if (this.viewMode === 'kanban') {
                    this.renderKanbanView(container, projects);
                }
            }
            
            renderListView(container, projects) {
                container.className = 'projects-list';
                container.innerHTML = '';
                
                // Add list header
                const totalProjects = projects.length;
                const completedTasks = projects.reduce((sum, p) => sum + p.tasks.filter(t => t.completed).length, 0);
                const totalTasks = projects.reduce((sum, p) => sum + p.tasks.length, 0);
                
                const header = document.createElement('div');
                header.className = 'list-view-header';
                header.innerHTML = `
                    <div class="list-view-title">📋 Projects List View</div>
                    <div class="list-view-stats">
                        <span><strong>${totalProjects}</strong> projects</span>
                        <span><strong>${completedTasks}/${totalTasks}</strong> tasks completed</span>
                        <span><strong>${totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0}%</strong> overall progress</span>
                    </div>
                `;
                container.appendChild(header);
                
                if (projects.length === 0) {
                    container.innerHTML += `
                        <div style="text-align: center; padding: 60px; color: #9ca3af;">
                            <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                            <p>No projects found matching your search</p>
                        </div>
                    `;
                    return;
                }
                
                projects.forEach(project => {
                    const listItem = this.createListItem(project);
                    container.appendChild(listItem);
                });
            }
            
            createListItem(project) {
                const isFocused = project.id === this.focusProject;
                const completedTasks = project.tasks.filter(task => task.completed).length;
                const totalTasks = project.tasks.length;
                const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                const deadlineStatus = this.getDeadlineStatus(project.deadline);
                
                const item = document.createElement('div');
                item.className = `list-item ${isFocused ? 'focused' : ''}`;
                item.onclick = () => this.navigateToProject(project.id);
                
                let deadlineHtml = '';
                if (project.deadline) {
                    deadlineHtml = `
                        <div class="list-item-deadline ${deadlineStatus}">
                            <span>📅</span> ${this.formatDeadline(project.deadline)}
                        </div>
                    `;
                }
                
                let tagsHtml = '';
                if (project.tags && project.tags.length > 0) {
                    tagsHtml = `
                        <div class="list-item-tags">
                            ${project.tags.slice(0, 3).map(tag => 
                                `<span class="tag tag-${this.getTagCategory(tag)}">${tag}</span>`
                            ).join('')}
                            ${project.tags.length > 3 ? `<span class="tag tag-custom">+${project.tags.length - 3}</span>` : ''}
                        </div>
                    `;
                }
                
                item.innerHTML = `
                    <div class="list-item-header">
                        <div class="list-item-info">
                            <div class="list-item-title">
                                ${project.name}
                                ${isFocused ? '<span class="focus-badge" style="margin-left: 12px;">🎯 Focus</span>' : ''}
                            </div>
                            <div class="list-item-client">${project.client}</div>
                            <div class="list-item-context">${project.context}</div>
                            <div class="list-item-meta">
                                <div class="list-item-progress">
                                    <div class="list-progress-bar">
                                        <div class="list-progress-fill ${isFocused ? 'focused' : ''}" style="width: ${completionPercentage}%"></div>
                                    </div>
                                    <span style="font-size: 12px; color: #64748b;">${completedTasks}/${totalTasks} (${completionPercentage}%)</span>
                                </div>
                                ${deadlineHtml}
                                ${tagsHtml}
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn btn-outline" style="padding: 6px 12px; font-size: 13px;" onclick="event.stopPropagation(); window.taskManager.showEditProjectModal('${project.id}')">✏️ Edit</button>
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 13px;" onclick="event.stopPropagation(); window.taskManager.navigateToProject('${project.id}')">👁️ View</button>
                        </div>
                    </div>
                `;
                
                return item;
            }
            
            renderKanbanView(container, projects) {
                container.className = 'projects-kanban';
                container.innerHTML = '';
                // Define task status columns
                const columns = [
                    { id: 'not-started', title: '📝 Not Started', filter: t => t.status === 'not-started' },
                    { id: 'in-progress', title: '🚀 In Progress', filter: t => t.status === 'in-progress' },
                    { id: 'review', title: '👀 Review', filter: t => t.status === 'review' },
                    { id: 'completed', title: '✅ Completed', filter: t => t.status === 'completed' }
                ];
                // Gather all tasks with project context
                let allTasks = [];
                projects.forEach(project => {
                    project.tasks.forEach(task => {
                        allTasks.push({
                            ...task,
                            projectName: project.name,
                            projectId: project.id,
                            projectClient: project.client,
                            projectColor: '#0700ff',
                            tags: task.tags || [],
                        });
                    });
                });
                columns.forEach(column => {
                    const columnTasks = allTasks.filter(column.filter);
                    const columnElement = document.createElement('div');
                    columnElement.className = 'kanban-column';
                    columnElement.innerHTML = `
                        <div class="kanban-header">
                            <div class="kanban-title">${column.title}</div>
                            <div class="kanban-count">${columnTasks.length}</div>
                        </div>
                        <div class="kanban-items" id="kanban-items-${column.id}"></div>
                    `;
                    const itemsContainer = columnElement.querySelector('.kanban-items');
                    // Group tasks by project
                    const tasksByProject = {};
                    columnTasks.forEach(task => {
                        if (!tasksByProject[task.projectId]) tasksByProject[task.projectId] = [];
                        tasksByProject[task.projectId].push(task);
                    });
                    Object.keys(tasksByProject).forEach(projectId => {
                        const projectTasks = tasksByProject[projectId];
                        // Project header
                        const projectHeader = document.createElement('div');
                        projectHeader.style = 'font-weight: 600; color: #0700ff; margin: 8px 0 4px 0; font-size: 0.98rem;';
                        projectHeader.textContent = projectTasks[0].projectName;
                        itemsContainer.appendChild(projectHeader);
                        // Tasks
                        projectTasks.forEach(task => {
                            const card = document.createElement('div');
                            card.className = 'kanban-card';
                            card.setAttribute('onclick', `window.taskManager.showEditTaskModal('${task.projectId}', '${task.id}')`);
                            let tagsHtml = '';
                            if (task.tags && task.tags.length > 0) {
                                tagsHtml = `<div class=\"kanban-card-tags\">` +
                                    task.tags.slice(0, 2).map(tag => `<span class=\"kanban-tag\">${tag}</span>`).join('') +
                                    `</div>`;
                            }
                            // Show only a snippet of the task text
                            let taskSnippet = task.text.length > 60 ? task.text.slice(0, 60) + '…' : task.text;
                            card.innerHTML = `
                                <div class=\"kanban-card-project\" style=\"font-weight:700;font-size:1.05rem;color:#0700ff;margin-bottom:4px;\">${task.projectName}</div>
                                <div class=\"kanban-card-title\" style=\"font-size:0.98rem;font-weight:500;margin-bottom:2px;\">${taskSnippet}</div>
                                ${tagsHtml}
                            `;
                            itemsContainer.appendChild(card);
                        });
                    });
                    container.appendChild(columnElement);
                });
            }
            
            createKanbanColumn(column, projects) {
                const columnElement = document.createElement('div');
                columnElement.className = 'kanban-column';
                columnElement.dataset.columnId = column.id;
                
                columnElement.innerHTML = `
                    <div class="kanban-header">
                        <div class="kanban-title">
                            ${column.title}
                        </div>
                        <div class="kanban-count">${projects.length}</div>
                    </div>
                    <div class="kanban-items" id="kanban-items-${column.id}">
                        ${projects.length === 0 ? `
                            <div class="kanban-empty">
                                <div class="kanban-empty-icon">📭</div>
                                <p>No projects</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                const itemsContainer = columnElement.querySelector(`#kanban-items-${column.id}`);
                
                projects.forEach(project => {
                    const card = this.createKanbanCard(project);
                    if (projects.length > 0) {
                        itemsContainer.innerHTML = ''; // Clear empty message
                    }
                    itemsContainer.appendChild(card);
                });
                
                // Add drag and drop event listeners
                this.setupKanbanDragAndDrop(columnElement);
                
                return columnElement;
            }
            
            createKanbanCard(project) {
                const isFocused = project.id === this.focusProject;
                const completedTasks = project.tasks.filter(task => task.completed).length;
                const totalTasks = project.tasks.length;
                const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                const deadlineStatus = this.getDeadlineStatus(project.deadline);
                
                const card = document.createElement('div');
                card.className = `kanban-card ${isFocused ? 'focused' : ''}`;
                card.draggable = true;
                card.dataset.projectId = project.id;
                card.setAttribute('onclick', `window.taskManager.showEditTaskModal('${project.id}', '${project.tasks[0].id}')`);
                
                let deadlineHtml = '';
                if (project.deadline) {
                    deadlineHtml = `
                        <div class="kanban-card-deadline ${deadlineStatus}">
                            📅 ${this.formatDeadline(project.deadline)}
                        </div>
                    `;
                }
                
                let tagsHtml = '';
                if (project.tags && project.tags.length > 0) {
                    tagsHtml = project.tags.slice(0, 2).map(tag => 
                        `<span class="kanban-tag tag-${this.getTagCategory(tag)}">${tag}</span>`
                    ).join('');
                }
                
                card.innerHTML = `
                    <div class="kanban-card-header">
                        <div>
                            <div class="kanban-card-title">${project.name}</div>
                            <div class="kanban-card-client">${project.client}</div>
                        </div>
                        ${isFocused ? '<span style="font-size: 16px;">🎯</span>' : ''}
                    </div>
                    <div class="kanban-card-progress">
                        <div class="kanban-progress-bar">
                            <div class="kanban-progress-fill" style="width: ${completionPercentage}%"></div>
                        </div>
                        <span class="kanban-progress-text">${completionPercentage}%</span>
                    </div>
                    <div class="kanban-card-footer">
                        <div class="kanban-card-tags">${tagsHtml}</div>
                        ${deadlineHtml}
                    </div>
                `;
                
                return card;
            }
            
            setupKanbanDragAndDrop(column) {
                const items = column.querySelector('.kanban-items');
                
                items.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });
                
                items.addEventListener('dragleave', (e) => {
                    if (!column.contains(e.relatedTarget)) {
                        column.classList.remove('drag-over');
                    }
                });
                
                items.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    const projectId = parseInt(e.dataTransfer.getData('text/plain'));
                    const newStatus = column.dataset.columnId;
                    
                    // Update project status
                    const project = this.projects.find(p => p.id === projectId);
                    if (project && project.status !== newStatus) {
                        const oldStatus = project.status || 'auto';
                        project.status = newStatus;
                        
                        // Add to activity log
                        this.activityLog.unshift({
                            id: this.activityLog.length + 1,
                            type: 'updated',
                            icon: '📊',
                            description: `Moved project from ${this.getStatusDisplayName(oldStatus)} to ${this.getStatusDisplayName(newStatus)}`,
                            project: project.name,
                            projectId: project.id,
                            time: new Date()
                        });
                        
                        this.renderKanbanView(document.getElementById('projects-container'), this.getFilteredAndSortedProjects());
                        this.triggerAutoSave();
                        
                        this.showToast(`📊 Project moved to ${this.getStatusDisplayName(newStatus)}!`, 'success');
                    }
                });
                
                // Add drag start event for cards
                column.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('kanban-card')) {
                        e.target.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', e.target.dataset.projectId);
                    }
                });
                
                column.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('kanban-card')) {
                        e.target.classList.remove('dragging');
                    }
                });
            }
            
            getStatusDisplayName(status) {
                const statusNames = {
                    'not-started': 'Not Started',
                    'in-progress': 'In Progress', 
                    'review': 'Review',
                    'completed': 'Completed',
                    'auto': 'Auto-categorized'
                };
                return statusNames[status] || status;
            }
            
            createProjectCard(project) {
                const isFocused = project.id === this.focusProject;
                const completedTasks = project.tasks.filter(task => task.completed).length;
                const totalTasks = project.tasks.length;
                const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                const card = document.createElement('div');
                card.className = `project-card ${isFocused ? 'focused' : ''}`;
                card.onclick = () => this.navigateToProject(project.id);
                
                card.innerHTML = `
                    <div class="project-header">
                        <div class="project-title-group">
                            <div class="project-icon ${isFocused ? 'focused' : ''}">
                                👤
                            </div>
                            <div>
                                <h2 class="project-title">${project.name}</h2>
                                <p class="project-client">${project.client}</p>
                            </div>
                            ${isFocused ? '<div class="focus-badge">🎯 Today\'s Focus</div>' : ''}
                        </div>
                        <div class="progress-group">
                            <span class="progress-text">${completedTasks}/${totalTasks} completed</span>
                            <div class="progress-bar">
                                <div class="progress-fill ${isFocused ? 'focused' : ''}" style="width: ${completionPercentage}%"></div>
                            </div>
                            <span class="progress-percentage">${completionPercentage}%</span>
                        </div>
                    </div>
                    
                    <div class="project-context ${isFocused ? 'focused' : ''}">
                        <p class="context-text">
                            <span class="context-label">Context:</span> ${project.context}
                        </p>
                    </div>
                `;
                
                return card;
            }
            
            renderProjectDetail() {
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('project-detail-view').classList.remove('hidden');
                
                const project = this.projects.find(p => String(p.id) === String(this.currentProjectId));
                if (!project) {
                    this.navigateToHome();
                    return;
                }
                
                const container = document.getElementById('project-detail-view');
                const completedTasks = project.tasks.filter(task => task.completed).length;
                const totalTasks = project.tasks.length;
                const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                const overdueTasks = project.tasks.filter(task => this.getDeadlineStatus(task.deadline) === 'overdue').length;
                const dueTodayTasks = project.tasks.filter(task => this.getDeadlineStatus(task.deadline) === 'due-today').length;
                
                const deadlineStatus = this.getDeadlineStatus(project.deadline);
                let iconClass = 'project-detail-icon';
                if (deadlineStatus === 'overdue') iconClass += ' overdue';
                else if (deadlineStatus === 'due-soon') iconClass += ' due-soon';
                
                container.innerHTML = `
                    <div class="project-detail">
                        <div class="project-detail-header">
                            <div class="project-detail-title-group">
                                <div class="${iconClass}">👤</div>
                                <div>
                                    <h1 class="project-detail-title">${project.name}</h1>
                                    <p class="project-detail-client">${project.client}</p>
                                </div>
                            </div>
                            <div class="project-detail-actions">
                                <button class="btn btn-outline" onclick="window.taskManager.showEditProjectModal('${project.id}')">
                                    <span>⚙️</span> Edit Project
                                </button>
                                <button class="btn btn-primary" onclick="window.taskManager.addTaskToProject('${project.id}')">
                                    <span>➕</span> Add Task
                                </button>
                                <button class="btn btn-success" onclick="window.taskManager.saveAllFiles()">
                                    <span>💾</span> Save
                                </button>
                            </div>
                        </div>
                        
                        <div class="project-detail-stats">
                            <div class="project-stat">
                                <div class="project-stat-value">${totalTasks}</div>
                                <div class="project-stat-label">Total Tasks</div>
                            </div>
                            <div class="project-stat">
                                <div class="project-stat-value">${completedTasks}</div>
                                <div class="project-stat-label">Completed</div>
                            </div>
                            <div class="project-stat">
                                <div class="project-stat-value">${overdueTasks}</div>
                                <div class="project-stat-label">Overdue</div>
                            </div>
                            <div class="project-stat">
                                <div class="project-stat-value">${dueTodayTasks}</div>
                                <div class="project-stat-label">Due Today</div>
                            </div>
                        </div>
                        
                        <div class="project-progress-large">
                            <div class="progress-header-large">
                                <h3 class="progress-title-large">Project Progress</h3>
                                <span class="progress-percentage-large">${completionPercentage}%</span>
                            </div>
                            <div class="progress-bar-large">
                                <div class="progress-fill-large" style="width: ${completionPercentage}%"></div>
                            </div>
                            <div class="progress-details">
                                <span>${completedTasks} of ${totalTasks} tasks completed</span>
                                <span>${totalTasks - completedTasks} remaining</span>
                            </div>
                        </div>
                        
                        <div class="detailed-tasks">
                            <div class="detailed-tasks-header">
                                <h3 class="detailed-tasks-title">
                                    <span>📋</span> Tasks
                                </h3>
                                <div class="task-filters">
                                    <button class="task-filter-btn ${this.taskFilter === 'all' ? 'active' : ''}" onclick="window.taskManager.setTaskFilter('all')">All</button>
                                    <button class="task-filter-btn ${this.taskFilter === 'active' ? 'active' : ''}" onclick="window.taskManager.setTaskFilter('active')">Active</button>
                                    <button class="task-filter-btn ${this.taskFilter === 'completed' ? 'active' : ''}" onclick="window.taskManager.setTaskFilter('completed')">Completed</button>
                                </div>
                                <div class="task-search">
                                    <input type="text" class="task-search-input" id="task-search-input" placeholder="Search tasks..." oninput="window.taskManager.setTaskSearch(this.value)">
                                </div>
                            </div>
                            <div id="detailed-tasks-list">
                                ${this.renderDetailedTasks(project)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderDetailedTasks(project) {
                let tasks = project.tasks;

                // Apply filter
                if (this.taskFilter === 'active') {
                    tasks = tasks.filter(task => !task.completed);
                } else if (this.taskFilter === 'completed') {
                    tasks = tasks.filter(task => task.completed);
                }

                // Apply search
                if (this.taskSearch) {
                    const search = this.taskSearch.toLowerCase();
                    tasks = tasks.filter(task =>
                        task.text.toLowerCase().includes(search) ||
                        (task.tags && task.tags.some(tag => tag.toLowerCase().includes(search)))
                    );
                }
                
                if (tasks.length === 0) {
                    const filterText = this.taskFilter === 'all' ? '' : this.taskFilter + ' ';
                    return `
                        <div style="text-align: center; padding: 40px; color: #9ca3af;">
                            <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                            <p>No ${filterText}tasks found${this.taskSearch ? ' for "' + this.taskSearch + '"' : ''}</p>
                        </div>
                    `;
                }
                
                return tasks.map(task => {
                    const isPriority = this.dailyPriorities.includes(`${project.id}-${task.id}`);
                    const deadlineStatus = this.getDeadlineStatus(task.deadline);
                    
                    let taskClass = 'detailed-task-item';
                    if (task.completed) taskClass += ' completed';
                    if (isPriority) taskClass += ' priority';
                    if (deadlineStatus === 'overdue') taskClass += ' overdue';
                    
                    let deadlineHtml = '';
                    if (task.deadline) {
                        deadlineHtml = `
                            <div class="detailed-task-deadline ${deadlineStatus}">
                                <span>⏰</span> ${this.formatDeadline(task.deadline)}
                            </div>
                        `;
                    }
                    
                    let tagsHtml = '';
                    if (task.tags && task.tags.length > 0) {
                        tagsHtml = task.tags.map(tag => 
                            `<span class="tag tag-${this.getTagCategory(tag)}">${tag}</span>`
                        ).join('');
                    }
                    
                    return `
                        <div class="${taskClass}">
                            <div class="detailed-task-header">
                                <div class="detailed-task-content">
                                    <div class="detailed-task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                                    <div class="detailed-task-meta">
                                        ${deadlineHtml}
                                        ${tagsHtml}
                                        ${isPriority ? '<span class="tag tag-priority">⭐ Priority</span>' : ''}
                                    </div>
                                </div>
                                <div class="detailed-task-actions">
                                    <button class="task-btn ${task.completed ? 'active' : ''}" onclick="window.taskManager.toggleTask('${project.id}', '${task.id}')" title="Toggle completion">
                                        ${task.completed ? '✅' : '⭕'}
                                    </button>
                                    <button class="task-btn ${isPriority ? 'priority' : ''}" onclick="window.taskManager.togglePriority('${project.id}', '${task.id}')" title="Toggle priority">
                                        ${isPriority ? '⭐' : '☆'}
                                    </button>
                                    <button class="task-btn" onclick="window.taskManager.showEditTaskModal('${project.id}', '${task.id}')" title="Edit task">✏️</button>
                                    <button class="task-btn" onclick="window.taskManager.deleteTask('${project.id}', '${task.id}')" title="Delete task">🗑️</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            renderProjectSwitcher() {
                const dropdown = document.getElementById('project-switcher-dropdown');
                dropdown.innerHTML = '';
                
                this.projects.forEach(project => {
                    const item = document.createElement('div');
                    item.className = `project-switcher-item ${project.id === this.currentProjectId ? 'active' : ''}`;
                    item.innerHTML = `
                        <div class="project-switcher-project">${project.name}</div>
                        <div class="project-switcher-client">${project.client}</div>
                    `;
                    item.onclick = () => {
                        this.navigateToProject(project.id);
                        dropdown.classList.add('hidden');
                    };
                    dropdown.appendChild(item);
                });
            }
            
            // UTILITY METHODS
            getTimeAgo(date) {
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / (1000 * 60));
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                return `${days}d ago`;
            }
            
            getDeadlineStatus(deadline) {
                if (!deadline) return 'no-deadline';
                
                const today = new Date();
                const deadlineDate = new Date(deadline);
                const diffTime = deadlineDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) return 'overdue';
                if (diffDays === 0) return 'due-today';
                if (diffDays <= 7) return 'due-soon';
                return 'due-later';
            }
            
            formatDeadline(deadline) {
                if (!deadline) return '';
                
                const date = new Date(deadline);
                const today = new Date();
                const diffTime = date - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    return `${Math.abs(diffDays)} days overdue`;
                } else if (diffDays === 0) {
                    return 'Due today';
                } else if (diffDays === 1) {
                    return 'Due tomorrow';
                } else if (diffDays <= 7) {
                    return `Due in ${diffDays} days`;
                } else {
                    return date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
                    });
                }
            }
            
            getTagCategory(tag) {
                const categories = {
                    client: ['client', 'bmw', 'zeno', 'personal', 'internal'],
                    priority: ['urgent', 'high', 'critical', 'important'],
                    status: ['active', 'completed', 'on-hold', 'pending'],
                    type: ['dashboard', 'development', 'design', 'research', 'testing', 'documentation']
                };
                
                for (const [category, keywords] of Object.entries(categories)) {
                    if (keywords.some(keyword => tag.toLowerCase().includes(keyword))) {
                        return category;
                    }
                }
                
                return 'custom';
            }
            
            getOverdueTasks() {
                const overdue = [];
                this.projects.forEach(project => {
                    project.tasks.forEach(task => {
                        if (this.getDeadlineStatus(task.deadline) === 'overdue') {
                            overdue.push({ ...task, projectId: project.id, projectName: project.name });
                        }
                    });
                });
                return overdue;
            }
            
            getDueTodayTasks() {
                const dueToday = [];
                this.projects.forEach(project => {
                    project.tasks.forEach(task => {
                        if (this.getDeadlineStatus(task.deadline) === 'due-today') {
                            dueToday.push({ ...task, projectId: project.id, projectName: project.name });
                        }
                    });
                });
                return dueToday;
            }
            
            // TASK MANAGEMENT METHODS
            setTaskFilter(filter) {
                this.taskFilter = filter;
                this.renderProjectDetail();
            }

            setTaskSearch(query) {
                this.taskSearch = query;
                this.renderProjectDetail();
            }
            
            toggleTask(projectId, taskId) {
                const project = this.projects.find(p => p.id === projectId);
                const task = project.tasks.find(t => t.id === taskId);
                task.completed = !task.completed;
                
                // Add to activity log
                this.activityLog.unshift({
                    id: this.activityLog.length + 1,
                    type: task.completed ? 'completed' : 'created',
                    icon: task.completed ? '✅' : '⭕',
                    description: `${task.completed ? 'Completed' : 'Reopened'} task: ${task.text.substring(0, 50)}${task.text.length > 50 ? '...' : ''}`,
                    project: project.name,
                    projectId: project.id,
                    time: new Date()
                });
                
                this.render();
                this.triggerAutoSave();
            }
            
            togglePriority(projectId, taskId) {
                const priorityKey = `${projectId}-${taskId}`;
                const index = this.dailyPriorities.indexOf(priorityKey);
                
                if (index > -1) {
                    this.dailyPriorities.splice(index, 1);
                } else {
                    this.dailyPriorities.push(priorityKey);
                }
                
                this.render();
                this.triggerAutoSave();
            }
            
            addTaskToProject(projectId) {
                this.addingTaskProjectId = projectId;
                document.getElementById('add-task-text').value = '';
                document.getElementById('add-task-tags').value = '';
                document.getElementById('add-task-modal').classList.remove('hidden');
                document.getElementById('add-task-text').focus();
            }
            
            deleteTask(projectId, taskId) {
                const project = this.projects.find(p => String(p.id) === String(projectId));
                const task = project.tasks.find(t => t.id === taskId);
                
                if (confirm(`Are you sure you want to delete this task?\n\n"${task.text}"`)) {
                    project.tasks = project.tasks.filter(t => t.id !== taskId);
                    
                    // Remove from priorities if it was there
                    const priorityKey = `${projectId}-${taskId}`;
                    const index = this.dailyPriorities.indexOf(priorityKey);
                    if (index > -1) {
                        this.dailyPriorities.splice(index, 1);
                    }
                    
                    this.updateAllTags();
                    this.render();
                    this.triggerAutoSave();
                }
            }
            
            // MODAL METHODS (Simplified for demo)
            // Modal Functions - Restored and Enhanced
            showAddProjectModal() {
                this.closeAllModals();
                document.getElementById('add-project-modal').classList.remove('hidden');
                document.getElementById('add-project-name').focus();
            }
            
            hideAddProjectModal() {
                document.getElementById('add-project-modal').classList.add('hidden');
                this.clearAddProjectForm();
            }
            
            clearAddProjectForm() {
                document.getElementById('add-project-name').value = '';
                document.getElementById('add-project-client').value = '';
                document.getElementById('add-project-context').value = '';
                document.getElementById('add-project-tags').value = '';
                document.getElementById('add-project-deadline').value = '';
                document.getElementById('add-project-status').value = 'not-started';
                document.getElementById('add-initial-tasks').value = '';
            }
            
            createNewProject() {
                const name = document.getElementById('add-project-name').value.trim();
                const client = document.getElementById('add-project-client').value.trim();
                const context = document.getElementById('add-project-context').value.trim();
                const tagsText = document.getElementById('add-project-tags').value.trim();
                const deadline = document.getElementById('add-project-deadline').value || null;
                const status = document.getElementById('add-project-status').value;
                const initialTasks = document.getElementById('add-initial-tasks').value.trim();
                
                if (!name || !client || !context) {
                    this.showToast('❌ Please fill in all required fields (Name, Client, Context)', 'error');
                    return;
                }
                
                const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                
                const newProject = {
                    id: Math.max(...this.projects.map(p => p.id), 0) + 1,
                    name: name,
                    client: client,
                    context: context,
                    deadline: deadline,
                    status: status,
                    tags: tags,
                    tasks: []
                };
                
                if (initialTasks) {
                    const taskLines = initialTasks.split('\n').filter(line => line.trim());
                    taskLines.forEach((taskText, index) => {
                        newProject.tasks.push({
                            id: index + 1,
                            text: taskText.trim(),
                            completed: false,
                            tags: [],
                            deadline: null
                        });
                    });
                }
                
                this.projects.push(newProject);
                this.updateAllTags();
                this.hideAddProjectModal();
                this.render();
                this.triggerAutoSave();
                
                this.showToast(`✅ Project "${name}" has been created!`, 'success');
            }
            
            showEditProjectModal(projectId) {
                this.closeAllModals();
                this.editingProjectId = projectId;
                const project = this.projects.find(p => String(p.id) === String(projectId));
                
                if (project) {
                    document.getElementById('edit-project-name').value = project.name;
                    document.getElementById('edit-project-client').value = project.client;
                    document.getElementById('edit-project-context').value = project.context;
                    document.getElementById('edit-project-deadline').value = project.deadline ? project.deadline.split('T')[0] : '';
                    document.getElementById('edit-project-status').value = project.status || 'not-started';
                    document.getElementById('edit-project-tags').value = project.tags ? project.tags.join(', ') : '';
                    
                    document.getElementById('edit-project-modal').classList.remove('hidden');
                    document.getElementById('edit-project-name').focus();
                }
            }
            
            hideEditProjectModal() {
                document.getElementById('edit-project-modal').classList.add('hidden');
                this.clearEditProjectForm();
                this.editingProjectId = null;
            }
            
            clearEditProjectForm() {
                document.getElementById('edit-project-name').value = '';
                document.getElementById('edit-project-client').value = '';
                document.getElementById('edit-project-context').value = '';
                document.getElementById('edit-project-deadline').value = '';
                document.getElementById('edit-project-status').value = 'not-started';
                document.getElementById('edit-project-tags').value = '';
            }
            
            saveProjectChanges() {
                if (!this.editingProjectId) return;
                
                const project = this.projects.find(p => String(p.id) === String(this.editingProjectId));
                if (!project) return;
                
                const name = document.getElementById('edit-project-name').value.trim();
                const client = document.getElementById('edit-project-client').value.trim();
                const context = document.getElementById('edit-project-context').value.trim();
                const deadline = document.getElementById('edit-project-deadline').value || null;
                const status = document.getElementById('edit-project-status').value;
                const tagsText = document.getElementById('edit-project-tags').value.trim();
                
                if (!name || !client || !context) {
                    this.showToast('❌ Please fill in all required fields (Name, Client, Context)', 'error');
                    return;
                }
                
                if (deadline && !this.isValidDate(deadline)) {
                    this.showToast('❌ Invalid deadline format', 'error');
                    return;
                }
                
                const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                
                // Update project
                project.name = name;
                project.client = client;
                project.context = context;
                project.deadline = deadline;
                project.status = status;
                project.tags = tags;
                
                this.updateAllTags();
                this.hideEditProjectModal();
                this.render();
                this.triggerAutoSave();
                
                this.showToast(`✅ Project "${name}" updated successfully!`, 'success');
            }
            
            deleteProject() {
                if (!this.editingProjectId) return;
                
                const project = this.projects.find(p => String(p.id) === String(this.editingProjectId));
                if (!project) return;
                
                const confirmed = confirm(`Are you sure you want to delete the project "${project.name}"?\n\nThis will permanently delete the project and all its tasks. This action cannot be undone.`);
                
                if (confirmed) {
                    // Remove project from array
                    this.projects = this.projects.filter(p => p.id !== this.editingProjectId);
                    
                    // Remove any priorities associated with this project
                    this.dailyPriorities = this.dailyPriorities.filter(priority => {
                        const [projectId] = priority.split('-');
                        return parseInt(projectId) !== this.editingProjectId;
                    });
                    
                    // Clear focus if this was the focused project
                    if (this.focusProject === this.editingProjectId) {
                        this.focusProject = null;
                    }
                    
                    // Navigate to home if we're viewing this project
                    if (this.currentProjectId === this.editingProjectId) {
                        this.navigateToHome();
                    }
                    
                    this.updateAllTags();
                    this.hideEditProjectModal();
                    this.render();
                    this.triggerAutoSave();
                    
                    this.showToast(`🗑️ Project "${project.name}" deleted successfully`, 'success');
                }
            }
            
            // Edit Task Modal Functions
            showEditTaskModal(projectId, taskId) {
                this.closeAllModals();
                this.editingTaskProjectId = projectId;
                this.editingTaskId = taskId;
                
                const project = this.projects.find(p => String(p.id) === String(projectId));
                const task = project.tasks.find(t => t.id === taskId);
                
                if (task) {
                    document.getElementById('edit-task-text').value = task.text;
                    document.getElementById('edit-task-deadline').value = task.deadline ? task.deadline.split('T')[0] : '';
                    document.getElementById('edit-task-tags').value = task.tags ? task.tags.join(', ') : '';
                    document.getElementById('edit-task-completed').checked = task.completed;
                    
                    // Set priority status
                    const isPriority = this.dailyPriorities.includes(`${projectId}-${taskId}`);
                    document.getElementById('edit-task-priority').value = isPriority.toString();
                    
                    document.getElementById('edit-task-status').value = task.status || 'not-started';
                    
                    document.getElementById('edit-task-modal').classList.remove('hidden');
                    document.getElementById('edit-task-text').focus();
                }
            }
            
            hideEditTaskModal() {
                document.getElementById('edit-task-modal').classList.add('hidden');
                this.clearEditTaskForm();
                this.editingTaskId = null;
                this.editingTaskProjectId = null;
            }
            
            clearEditTaskForm() {
                document.getElementById('edit-task-text').value = '';
                document.getElementById('edit-task-deadline').value = '';
                document.getElementById('edit-task-tags').value = '';
                document.getElementById('edit-task-completed').checked = false;
                document.getElementById('edit-task-priority').value = 'false';
            }
            
            saveTaskChanges() {
                if (!this.editingTaskId || !this.editingTaskProjectId) return;
                
                const project = this.projects.find(p => String(p.id) === String(this.editingTaskProjectId));
                const task = project.tasks.find(t => t.id === this.editingTaskId);
                
                if (!task) return;
                
                const text = document.getElementById('edit-task-text').value.trim();
                const deadline = document.getElementById('edit-task-deadline').value || null;
                const tagsText = document.getElementById('edit-task-tags').value.trim();
                const completed = document.getElementById('edit-task-completed').checked;
                const isPriority = document.getElementById('edit-task-priority').value === 'true';
                const status = document.getElementById('edit-task-status').value;
                
                if (!text) {
                    this.showToast('❌ Task description cannot be empty', 'error');
                    return;
                }
                
                if (deadline && !this.isValidDate(deadline)) {
                    this.showToast('❌ Invalid deadline format', 'error');
                    return;
                }
                
                const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                
                // Update task
                task.text = text;
                task.deadline = deadline;
                task.tags = tags;
                task.completed = completed;
                task.status = status;
                
                // Handle priority status
                const priorityKey = `${this.editingTaskProjectId}-${this.editingTaskId}`;
                const currentlyPriority = this.dailyPriorities.includes(priorityKey);
                
                if (isPriority && !currentlyPriority) {
                    this.dailyPriorities.push(priorityKey);
                } else if (!isPriority && currentlyPriority) {
                    const index = this.dailyPriorities.indexOf(priorityKey);
                    this.dailyPriorities.splice(index, 1);
                }
                
                this.updateAllTags();
                this.hideEditTaskModal();
                this.render();
                this.triggerAutoSave();
                
                this.showToast('✅ Task updated successfully!', 'success');
            }
            
            deleteTaskFromModal() {
                if (!this.editingTaskId || !this.editingTaskProjectId) return;
                
                const project = this.projects.find(p => String(p.id) === String(this.editingTaskProjectId));
                const task = project.tasks.find(t => t.id === this.editingTaskId);
                
                if (!task) return;
                
                const confirmed = confirm(`Are you sure you want to delete this task?\n\n"${task.text}"\n\nThis action cannot be undone.`);
                
                if (confirmed) {
                    // Remove task from project
                    project.tasks = project.tasks.filter(t => t.id !== this.editingTaskId);
                    
                    // Remove from priorities if it was there
                    const priorityKey = `${this.editingTaskProjectId}-${this.editingTaskId}`;
                    const index = this.dailyPriorities.indexOf(priorityKey);
                    if (index > -1) {
                        this.dailyPriorities.splice(index, 1);
                    }
                    
                    this.updateAllTags();
                    this.hideEditTaskModal();
                    this.render();
                    this.triggerAutoSave();
                    
                    this.showToast('🗑️ Task deleted successfully', 'success');
                }
            }
            
            closeAllModals() {
                document.getElementById('add-project-modal').classList.add('hidden');
                document.getElementById('edit-project-modal').classList.add('hidden');
                document.getElementById('edit-task-modal').classList.add('hidden');
                this.clearAddProjectForm();
                this.clearEditProjectForm();
                this.clearEditTaskForm();
                this.editingProjectId = null;
                this.editingTaskId = null;
                this.editingTaskProjectId = null;
            }
            
            isValidDate(dateString) {
                const regex = /^\d{4}-\d{2}-\d{2}$/;
                if (!regex.test(dateString)) return false;
                
                const date = new Date(dateString);
                return date instanceof Date && !isNaN(date) && dateString === date.toISOString().split('T')[0];
            }
            
            toggleNotesSidebar() {
                const sidebar = document.getElementById('notes-sidebar');
                this.showNotes = !this.showNotes;
                
                if (this.showNotes) {
                    sidebar.classList.add('open');
                    this.renderNotes();
                    this.renderFloatingNotes();
                } else {
                    sidebar.classList.remove('open');
                }
            }
            
            // NOTES FUNCTIONALITY - Restored from Phase 3
            addNoteFromInput() {
                const input = document.getElementById('quick-note-input');
                const priority = document.getElementById('note-priority').value;
                const content = input.value.trim();
                
                if (content) {
                    this.addNote(content, this.selectedNoteColor, priority);
                    input.value = '';
                }
            }
            
            addFloatingNoteFromInput() {
                const input = document.getElementById('quick-note-input');
                const content = input.value.trim();
                
                if (content) {
                    this.addFloatingNote(content);
                    input.value = '';
                }
            }
            
            addNote(content, color = 'yellow', priority = 'low', title = '') {
                if (!content.trim()) return;
                
                const newNote = {
                    id: Math.max(...this.notes.map(n => n.id), 0) + 1,
                    title: title || this.generateNoteTitle(content),
                    content: content,
                    color: color,
                    priority: priority,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                this.notes.unshift(newNote);
                this.renderNotes();
                this.triggerAutoSave();
                
                return newNote;
            }
            
            addFloatingNote(content, title = '') {
                if (!content.trim()) return;
                
                const newNote = {
                    id: Math.max(...this.floatingNotes.map(n => n.id), 0) + 1,
                    title: title || this.generateNoteTitle(content),
                    content: content,
                    position: { x: 100 + (this.floatingNotes.length * 20), y: 150 + (this.floatingNotes.length * 20) },
                    size: { width: 200, height: 120 }
                };
                
                this.floatingNotes.push(newNote);
                this.renderFloatingNotes();
                this.triggerAutoSave();
                
                return newNote;
            }
            
            generateNoteTitle(content) {
                const words = content.split(' ').slice(0, 4);
                return words.join(' ') + (content.split(' ').length > 4 ? '...' : '');
            }
            
            deleteNote(noteId) {
                this.notes = this.notes.filter(n => n.id !== noteId);
                this.renderNotes();
                this.triggerAutoSave();
            }
            
            deleteFloatingNote(noteId) {
                this.floatingNotes = this.floatingNotes.filter(n => n.id !== noteId);
                this.renderFloatingNotes();
                this.triggerAutoSave();
            }
            
            editNote(noteId, newContent) {
                const note = this.notes.find(n => n.id === noteId);
                if (note && newContent.trim()) {
                    note.content = newContent;
                    note.title = this.generateNoteTitle(newContent);
                    note.updatedAt = new Date().toISOString();
                    this.renderNotes();
                    this.triggerAutoSave();
                }
            }
            
            getFilteredNotes() {
                let filtered = [...this.notes];
                
                // Apply priority filter
                if (this.notesFilter !== 'all') {
                    filtered = filtered.filter(note => note.priority === this.notesFilter);
                }
                
                // Apply search filter
                if (this.notesSearch) {
                    const search = this.notesSearch.toLowerCase();
                    filtered = filtered.filter(note => 
                        note.title.toLowerCase().includes(search) ||
                        note.content.toLowerCase().includes(search)
                    );
                }
                
                return filtered;
            }
            
            renderNotes() {
                const container = document.getElementById('notes-list');
                const filteredNotes = this.getFilteredNotes();
                
                if (filteredNotes.length === 0) {
                    container.innerHTML = `
                        <div class="notes-empty">
                            <div class="notes-empty-icon">📝</div>
                            <p>No notes match your filter criteria.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                filteredNotes.forEach(note => {
                    const noteElement = document.createElement('div');
                    noteElement.className = `note-item ${note.color}`;
                    
                    const timestamp = new Date(note.updatedAt).toLocaleDateString();
                    
                    noteElement.innerHTML = `
                        <div class="note-header">
                            <div class="note-priority ${note.priority}">${note.priority}</div>
                            <div class="note-actions">
                                <button class="note-btn" onclick="window.taskManager.editNotePrompt(${note.id})" title="Edit note">✏️</button>
                                <button class="note-btn" onclick="window.taskManager.deleteNote(${note.id})" title="Delete note">🗑️</button>
                            </div>
                        </div>
                        <div class="note-title">${note.title}</div>
                        <div class="note-content">${note.content}</div>
                        <div class="note-timestamp">Updated: ${timestamp}</div>
                    `;
                    
                    container.appendChild(noteElement);
                });
            }
            
            editNotePrompt(noteId) {
                const note = this.notes.find(n => n.id === noteId);
                if (note) {
                    const newContent = prompt('Edit note:', note.content);
                    if (newContent !== null) {
                        this.editNote(noteId, newContent);
                    }
                }
            }
            
            renderFloatingNotes() {
                const container = document.getElementById('floating-notes');
                container.innerHTML = '';
                
                this.floatingNotes.forEach(note => {
                    const noteElement = document.createElement('div');
                    noteElement.className = 'floating-note';
                    noteElement.style.left = note.position.x + 'px';
                    noteElement.style.top = note.position.y + 'px';
                    noteElement.style.width = note.size.width + 'px';
                    noteElement.style.height = note.size.height + 'px';
                    
                    noteElement.innerHTML = `
                        <div class="floating-note-header">
                            <div class="floating-note-title">${note.title}</div>
                            <button class="floating-note-close" onclick="window.taskManager.deleteFloatingNote(${note.id})">×</button>
                        </div>
                        <div class="floating-note-content">${note.content}</div>
                    `;
                    
                    this.makeNoteDraggable(noteElement, note);
                    container.appendChild(noteElement);
                });
            }
            
            makeNoteDraggable(element, note) {
                let isDragging = false;
                let startX, startY, initialX, initialY;
                
                element.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.floating-note-close')) return;
                    
                    isDragging = true;
                    element.classList.add('dragging');
                    
                    startX = e.clientX;
                    startY = e.clientY;
                    initialX = note.position.x;
                    initialY = note.position.y;
                    
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    note.position.x = Math.max(0, Math.min(window.innerWidth - 200, initialX + deltaX));
                    note.position.y = Math.max(0, Math.min(window.innerHeight - 120, initialY + deltaY));
                    
                    element.style.left = note.position.x + 'px';
                    element.style.top = note.position.y + 'px';
                });
                
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        element.classList.remove('dragging');
                        this.triggerAutoSave();
                    }
                });
            }
            
            showDeadlineOverview() {
                this.showToast('⏰ Deadline overview feature coming soon!', 'info');
            }

            async exportAllData(filePath) {
                if (!this.isElectron) {
                    this.showToast('📤 Export only available in Electron', 'info');
                    return;
                }

                if (!filePath) {
                    const result = await window.electronAPI.showSaveDialog();
                    if (result.canceled) return;
                    filePath = result.filePath;
                }

                try {
                    const exportData = {
                        projects: this.projects,
                        notes: this.notes,
                        floatingNotes: this.floatingNotes,
                        focusProject: this.focusProject,
                        dailyPriorities: this.dailyPriorities,
                        exportDate: new Date().toISOString(),
                        version: '1.0.0'
                    };

                    const result = await window.electronAPI.writeFile(filePath, JSON.stringify(exportData, null, 2));

                    if (result.success) {
                        this.showToast('✅ Data exported successfully!', 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Export failed:', error);
                    this.showToast('❌ Export failed: ' + error.message, 'error');
                }
            }
            
            toggleFilters() {
                this.showToast('🔍 Advanced filters feature coming soon!', 'info');
            }
            
            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = 'success-toast';
                
                if (type === 'error') {
                    toast.style.background = '#ef4444';
                } else if (type === 'info') {
                    toast.style.background = '#3b82f6';
                }
                
                toast.innerHTML = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            showAllProjects() {
                this.currentView = 'all-projects';
                this.renderAllProjectsView();
            }

            renderAllProjectsView() {
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('project-detail-view').classList.add('hidden');
                let container = document.getElementById('all-projects-view');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'all-projects-view';
                    container.style.padding = '32px 0';
                    document.querySelector('.container').appendChild(container);
                }
                container.innerHTML = `<h2 style="font-family: 'Abril Fatface', serif; color: #0700ff; margin-bottom: 24px;">All Projects</h2>` +
                    this.projects.map(project => `
                        <div class="project-card" style="margin-bottom: 16px; cursor: pointer;" onclick="window.taskManager.navigateToProject('${project.id}')">
                            <div style="font-size: 1.1rem; font-weight: 600; color: #0700ff;">${project.name}</div>
                            <div style="font-size: 0.95rem; color: #64748b;">${project.client}</div>
                            <div style="font-size: 0.95rem; color: #374151; margin-top: 4px;">${project.context}</div>
                        </div>
                    `).join('');
                container.style.display = 'block';
                // Hide other views
                document.getElementById('dashboard-view').style.display = 'none';
                document.getElementById('project-detail-view').style.display = 'none';
            }

            hideAddTaskModal() {
              document.getElementById('add-task-modal').classList.add('hidden');
              this.addingTaskProjectId = null;
            }

            saveAddTask() {
              const text = document.getElementById('add-task-text').value.trim();
              const tagsText = document.getElementById('add-task-tags').value.trim();
              if (!text) {
                this.showToast('❌ Task description cannot be empty', 'error');
                return;
              }
              const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
              const project = this.projects.find(p => String(p.id) === String(this.addingTaskProjectId));
              if (!project) return;
              const newTask = {
                id: Math.max(...project.tasks.map(t => typeof t.id === 'number' ? t.id : 0), 0) + 1,
                text,
                completed: false,
                tags,
                deadline: null,
                status: document.getElementById('add-task-status').value
              };
              project.tasks.push(newTask);
              this.hideAddTaskModal();
              this.updateAllTags();
              this.render();
              this.triggerAutoSave();
              this.showToast('✅ Task added!', 'success');
            }
        }
        
        // Initialize the app when DOM is loaded
        window.addEventListener('DOMContentLoaded', () => {
            // Make taskManager globally accessible
            window.taskManager = new TaskManager();
            
            // Removed popstate handler - not needed in iframe environment
        });
    </script>
</body>
</html>